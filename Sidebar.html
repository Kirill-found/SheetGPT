<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      font-size: 13px;
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* === Compact Header === */
    .header {
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .header p {
      font-size: 11px;
      opacity: 0.9;
    }

    /* === Quick Actions Bar === */
    .quick-actions {
      background: white;
      padding: 8px;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
      display: flex;
      gap: 4px;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .quick-actions::-webkit-scrollbar {
      height: 3px;
    }

    .quick-actions::-webkit-scrollbar-thumb {
      background: #dadce0;
      border-radius: 2px;
    }

    .quick-btn {
      background: #f1f3f4;
      border: none;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
      font-weight: 500;
    }

    .quick-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-1px);
    }

    .quick-btn.active {
      background: #667eea;
      color: white;
    }

    /* === Mode Selector === */
    .mode-selector {
      background: white;
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
    }

    .mode-label {
      font-size: 11px;
      color: #5f6368;
      font-weight: 500;
    }

    .mode-toggle {
      display: flex;
      background: #f1f3f4;
      border-radius: 16px;
      padding: 2px;
    }

    .mode-btn {
      background: transparent;
      border: none;
      padding: 4px 12px;
      border-radius: 14px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      color: #5f6368;
    }

    .mode-btn.active {
      background: white;
      color: #667eea;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* === Chat Container === */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* === Messages === */
    .message {
      display: flex;
      gap: 6px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 85%;
      padding: 8px 12px;
      border-radius: 14px;
      word-wrap: break-word;
      font-size: 13px;
      line-height: 1.5;
    }

    .message.user .message-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.ai .message-bubble {
      background: white;
      color: #202124;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 4px;
    }

    /* === Response Formatting === */
    .response-type-badge {
      display: inline-block;
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 8px;
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: #e3f2fd;
      color: #1565c0;
    }

    .result-summary {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 8px;
      margin: 6px 0;
      border-left: 3px solid #667eea;
      font-weight: 500;
      white-space: pre-line;
    }

    .methodology {
      font-size: 11px;
      color: #5f6368;
      margin: 6px 0;
      padding: 6px 8px;
      background: #f8f9fa;
      border-radius: 6px;
      font-style: italic;
    }

    /* === Query History Sidebar === */
    .history-sidebar {
      background: white;
      border-right: 1px solid #e0e0e0;
      width: 180px;
      display: none;
      flex-direction: column;
      flex-shrink: 0;
    }

    .history-sidebar.visible {
      display: flex;
    }

    .history-header {
      padding: 8px 10px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      font-size: 11px;
      font-weight: 600;
      color: #202124;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-close {
      cursor: pointer;
      font-size: 16px;
      color: #5f6368;
      line-height: 1;
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 6px;
    }

    .history-item {
      padding: 8px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      border-left: 2px solid transparent;
    }

    .history-item:hover {
      background: #e8eaed;
      border-left-color: #667eea;
    }

    .history-item-text {
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      margin-bottom: 4px;
    }

    .history-item-time {
      font-size: 10px;
      color: #80868b;
    }

    /* === Input Area === */
    .input-container {
      flex-shrink: 0;
      padding: 8px 10px;
      background: white;
      border-top: 1px solid #e0e0e0;
    }

    .input-actions {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .input-action-btn {
      background: transparent;
      border: none;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 11px;
      cursor: pointer;
      color: #5f6368;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .input-action-btn:hover {
      background: #f1f3f4;
    }

    .input-action-btn.active {
      background: #e3f2fd;
      color: #1565c0;
    }

    .input-wrapper {
      display: flex;
      gap: 6px;
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      border: 1px solid #dadce0;
      border-radius: 20px;
      padding: 8px 14px;
      font-size: 13px;
      font-family: inherit;
      resize: none;
      max-height: 100px;
      overflow-y: auto;
      transition: all 0.2s;
    }

    #messageInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    }

    #sendBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    #sendBtn:hover {
      transform: scale(1.05);
    }

    #sendBtn:disabled {
      background: #dadce0;
      cursor: not-allowed;
    }

    /* === Batch Mode Panel === */
    .batch-panel {
      background: #fff3e0;
      padding: 8px 12px;
      border-bottom: 1px solid #ffb74d;
      font-size: 11px;
      display: none;
    }

    .batch-panel.visible {
      display: block;
    }

    .batch-info {
      color: #e65100;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .batch-controls {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .batch-input {
      flex: 1;
      padding: 4px 8px;
      border: 1px solid #ffb74d;
      border-radius: 6px;
      font-size: 11px;
    }

    .batch-apply-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      font-weight: 500;
    }

    /* === Loading === */
    .loading-dots {
      display: flex;
      gap: 4px;
      justify-content: center;
      padding: 10px;
    }

    .loading-dot {
      width: 6px;
      height: 6px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .loading-text {
      font-size: 11px;
      color: #5f6368;
      text-align: center;
      font-style: italic;
    }

    /* === Empty State === */
    .empty-state {
      text-align: center;
      padding: 20px 14px;
      color: #5f6368;
    }

    .empty-state-icon {
      font-size: 36px;
      margin-bottom: 8px;
    }

    .empty-state h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #202124;
    }

    .empty-state p {
      font-size: 12px;
      margin-bottom: 12px;
    }

    .example-queries {
      display: grid;
      gap: 6px;
      max-width: 260px;
      margin: 0 auto;
    }

    .example-query {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .example-query:hover {
      background: #f8f9fa;
      border-color: #667eea;
      transform: translateX(4px);
    }

    /* === Tooltip === */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #202124;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 6px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 10px;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* === Scrollbar === */
    .chat-container::-webkit-scrollbar {
      width: 5px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: #dadce0;
      border-radius: 3px;
    }

    /* === Main Layout === */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>üí¨ SheetGPT AI</h1>
    <p>99% —Ç–æ—á–Ω–æ—Å—Ç—å ‚Ä¢ AI Code Executor</p>
  </div>

  <!-- Quick Actions Bar -->
  <div class="quick-actions">
    <button class="quick-btn" onclick="useQuickAction('–¢–æ–ø 3 —Ç–æ–≤–∞—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º')">üìä –¢–æ–ø —Ç–æ–≤–∞—Ä—ã</button>
    <button class="quick-btn" onclick="useQuickAction('–£ –∫–∞–∫–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –±–æ–ª—å—à–µ –ø—Ä–æ–¥–∞–∂')">üè¢ –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</button>
    <button class="quick-btn" onclick="useQuickAction('–ü–æ—Å—á–∏—Ç–∞–π —Å—É–º–º—É')">‚ûï –°—É–º–º–∞</button>
    <button class="quick-btn" onclick="useQuickAction('–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞')">üìà –°—Ä–µ–¥–Ω–µ–µ</button>
    <button class="quick-btn" onclick="useQuickAction('–°–∫–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤')">üî¢ –ü–æ–¥—Å—á–µ—Ç</button>
  </div>

  <!-- Mode Selector -->
  <div class="mode-selector">
    <span class="mode-label">–†–µ–∂–∏–º:</span>
    <div class="mode-toggle">
      <button class="mode-btn active" id="singleModeBtn" onclick="switchMode('single')">–û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å</button>
      <button class="mode-btn" id="batchModeBtn" onclick="switchMode('batch')">
        <span class="tooltip">Batch
          <span class="tooltiptext">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Å—Ç—Ä–æ–∫–∞–º</span>
        </span>
      </button>
    </div>
    <button class="input-action-btn" onclick="toggleHistory()">
      üìú –ò—Å—Ç–æ—Ä–∏—è
    </button>
  </div>

  <!-- Batch Mode Panel -->
  <div class="batch-panel" id="batchPanel">
    <div class="batch-info">‚ö° Batch —Ä–µ–∂–∏–º: –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É</div>
    <div class="batch-controls">
      <input type="text" class="batch-input" id="batchRange" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A2:A10" value="A2:A10">
      <button class="batch-apply-btn" onclick="applyBatch()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Query History Sidebar -->
    <div class="history-sidebar" id="historySidebar">
      <div class="history-header">
        üìú –ò—Å—Ç–æ—Ä–∏—è
        <span class="history-close" onclick="toggleHistory()">√ó</span>
      </div>
      <div class="history-list" id="historyList">
        <div style="padding: 20px; text-align: center; font-size: 11px; color: #5f6368;">
          –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area">
      <!-- Chat Container -->
      <div class="chat-container" id="chatContainer">
        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
          <div class="empty-state-icon">üëã</div>
          <h2>–ü—Ä–∏–≤–µ—Ç! –Ø SheetGPT</h2>
          <p>–í–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å 99% —Ç–æ—á–Ω–æ—Å—Ç—å—é</p>

          <div style="text-align: left; max-width: 260px; margin: 0 auto 16px;">
            <p style="font-weight: 500; margin-bottom: 6px; font-size: 12px;">–ß—Ç–æ —è —É–º–µ—é:</p>
            <ul style="list-style: none; padding: 0; font-size: 11px; line-height: 1.7;">
              <li>üìä –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å 99% —Ç–æ—á–Ω–æ—Å—Ç—å—é</li>
              <li>üéØ –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å</li>
              <li>üîç –ù–∞—Ö–æ–¥–∏—Ç—å —Ç–æ–ø—ã –∏ –∞–Ω–æ–º–∞–ª–∏–∏</li>
              <li>üìà –°—á–∏—Ç–∞—Ç—å —Å—É–º–º—ã –∏ —Å—Ä–µ–¥–Ω–∏–µ</li>
            </ul>
          </div>

          <p style="font-weight: 500; font-size: 11px; margin-bottom: 10px;">–ü—Ä–∏–º–µ—Ä—ã:</p>
          <div class="example-queries">
            <div class="example-query" onclick="useExample('–¢–æ–ø 3 —Ç–æ–≤–∞—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º')">
              üìä –¢–æ–ø 3 —Ç–æ–≤–∞—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
            </div>
            <div class="example-query" onclick="useExample('–£ –∫–∞–∫–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –±–æ–ª—å—à–µ –ø—Ä–æ–¥–∞–∂')">
              üè¢ –£ –∫–∞–∫–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –±–æ–ª—å—à–µ –ø—Ä–æ–¥–∞–∂
            </div>
            <div class="example-query" onclick="useExample('–ü–æ—Å—á–∏—Ç–∞–π –æ–±—â—É—é —Å—É–º–º—É')">
              ‚ûï –ü–æ—Å—á–∏—Ç–∞–π –æ–±—â—É—é —Å—É–º–º—É
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="input-container">
        <div class="input-wrapper">
          <textarea
            id="messageInput"
            placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-—Ç–æ –æ –¥–∞–Ω–Ω—ã—Ö..."
            rows="2"
            onkeydown="handleKeyPress(event)"
          ></textarea>
          <button id="sendBtn" onclick="sendMessage()" disabled>
            ‚û§
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let isProcessing = false;
    let lastQuery = '';
    let queryHistory = [];
    let currentMode = 'single'; // 'single' or 'batch'

    // Initialize
    document.getElementById('messageInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';

      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = !this.value.trim() || isProcessing;
    });

    // Load history from localStorage
    function loadHistory() {
      try {
        const saved = localStorage.getItem('sheetgpt_query_history');
        if (saved) {
          queryHistory = JSON.parse(saved);
          updateHistoryUI();
        }
      } catch (e) {
        console.log('Could not load history:', e);
      }
    }

    // Save history to localStorage
    function saveHistory() {
      try {
        localStorage.setItem('sheetgpt_query_history', JSON.stringify(queryHistory.slice(-20)));
      } catch (e) {
        console.log('Could not save history:', e);
      }
    }

    // Add query to history
    function addToQueryHistory(query) {
      queryHistory.push({
        query: query,
        timestamp: new Date().toISOString()
      });
      saveHistory();
      updateHistoryUI();
    }

    // Update history UI
    function updateHistoryUI() {
      const list = document.getElementById('historyList');
      if (queryHistory.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; font-size: 11px; color: #5f6368;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        return;
      }

      list.innerHTML = '';
      const recent = queryHistory.slice(-20).reverse();

      recent.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.onclick = () => useHistoryItem(item.query);

        const text = document.createElement('div');
        text.className = 'history-item-text';
        text.textContent = item.query;

        const time = document.createElement('div');
        time.className = 'history-item-time';
        time.textContent = formatTimeAgo(new Date(item.timestamp));

        div.appendChild(text);
        div.appendChild(time);
        list.appendChild(div);
      });
    }

    // Toggle history sidebar
    function toggleHistory() {
      const sidebar = document.getElementById('historySidebar');
      sidebar.classList.toggle('visible');
    }

    // Use history item
    function useHistoryItem(query) {
      document.getElementById('messageInput').value = query;
      document.getElementById('sendBtn').disabled = false;
      toggleHistory();
    }

    // Switch mode
    function switchMode(mode) {
      currentMode = mode;
      document.getElementById('singleModeBtn').classList.toggle('active', mode === 'single');
      document.getElementById('batchModeBtn').classList.toggle('active', mode === 'batch');
      document.getElementById('batchPanel').classList.toggle('visible', mode === 'batch');
    }

    // Apply batch
    function applyBatch() {
      const range = document.getElementById('batchRange').value;
      const query = document.getElementById('messageInput').value.trim();

      if (!query) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å');
        return;
      }

      if (!range) {
        alert('–£–∫–∞–∂–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: A2:A10)');
        return;
      }

      // Add user message
      addMessage(`‚ö° Batch: "${query}" –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É ${range}`, 'user');

      // Add loading with progress
      const loadingMsg = `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é ${range}...`;
      addLoadingIndicatorWithProgress(loadingMsg);

      // Call backend batch processor
      google.script.run
        .withSuccessHandler(handleBatchResponse)
        .withFailureHandler(handleBatchError)
        .processBatchQuery(query, range);
    }

    // Handle batch response
    function handleBatchResponse(result) {
      removeLoadingIndicator();

      if (!result.success) {
        addMessage('‚ùå –û—à–∏–±–∫–∞ batch –æ–±—Ä–∞–±–æ—Ç–∫–∏', 'ai');
        return;
      }

      // Create summary message
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ai';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      // Badge
      const badge = document.createElement('div');
      badge.className = 'response-type-badge';
      badge.textContent = '‚ö° Batch —Ä–µ–∑—É–ª—å—Ç–∞—Ç';
      bubble.appendChild(badge);

      // Summary
      const summary = document.createElement('div');
      summary.className = 'result-summary';
      summary.innerHTML = `
        <strong>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${result.processed} —Å—Ç—Ä–æ–∫<br>
        <strong>–£—Å–ø–µ—à–Ω–æ:</strong> ${result.succeeded}<br>
        <strong>–û—à–∏–±–æ–∫:</strong> ${result.failed}
      `;
      bubble.appendChild(summary);

      // Results table
      if (result.results && result.results.length > 0) {
        const resultsDiv = document.createElement('div');
        resultsDiv.style.marginTop = '10px';
        resultsDiv.style.fontSize = '11px';

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';

        // Header
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th style="padding: 4px; border: 1px solid #e0e0e0;">–°—Ç—Ä–æ–∫–∞</th><th style="padding: 4px; border: 1px solid #e0e0e0;">–†–µ–∑—É–ª—å—Ç–∞—Ç</th></tr>';
        table.appendChild(thead);

        // Body
        const tbody = document.createElement('tbody');
        result.results.slice(0, 10).forEach(r => {
          const tr = document.createElement('tr');
          const statusIcon = r.success ? '‚úÖ' : '‚ùå';
          const resultText = r.success ? r.summary : r.error;
          tr.innerHTML = `
            <td style="padding: 4px; border: 1px solid #e0e0e0;">${statusIcon} ${r.row}</td>
            <td style="padding: 4px; border: 1px solid #e0e0e0; font-size: 10px;">${resultText}</td>
          `;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        if (result.results.length > 10) {
          const moreDiv = document.createElement('div');
          moreDiv.style.marginTop = '4px';
          moreDiv.style.fontSize = '10px';
          moreDiv.style.color = '#5f6368';
          moreDiv.textContent = `... –∏ –µ—â–µ ${result.results.length - 10} —Å—Ç—Ä–æ–∫`;
          resultsDiv.appendChild(table);
          resultsDiv.appendChild(moreDiv);
        } else {
          resultsDiv.appendChild(table);
        }

        bubble.appendChild(resultsDiv);
      }

      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);

      scrollToBottom();
    }

    // Handle batch error
    function handleBatchError(error) {
      removeLoadingIndicator();
      addMessage('‚ùå –û—à–∏–±–∫–∞ batch –æ–±—Ä–∞–±–æ—Ç–∫–∏: ' + (error.message || error), 'ai');
    }

    // Add loading indicator with progress support
    function addLoadingIndicatorWithProgress(message = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...') {
      const container = document.getElementById('chatContainer');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message ai';
      loadingDiv.id = 'loading';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      const dots = document.createElement('div');
      dots.className = 'loading-dots';
      dots.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';

      const text = document.createElement('div');
      text.className = 'loading-text';
      text.id = 'loading-progress-text';
      text.textContent = message;

      bubble.appendChild(dots);
      bubble.appendChild(text);
      loadingDiv.appendChild(bubble);
      container.appendChild(loadingDiv);

      scrollToBottom();
    }

    // Use quick action
    function useQuickAction(query) {
      document.getElementById('messageInput').value = query;
      document.getElementById('sendBtn').disabled = false;
      sendMessage();
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function useExample(query) {
      document.getElementById('messageInput').value = query;
      document.getElementById('sendBtn').disabled = false;
      sendMessage();
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message || isProcessing) return;

      lastQuery = message;
      addToQueryHistory(message);

      // Hide empty state
      const emptyState = document.getElementById('emptyState');
      if (emptyState) {
        emptyState.style.display = 'none';
      }

      // Add user message
      addMessage(message, 'user');

      // Clear input
      input.value = '';
      input.style.height = 'auto';
      document.getElementById('sendBtn').disabled = true;

      // Show loading
      isProcessing = true;
      addLoadingIndicator('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...');

      // Call backend
      google.script.run
        .withSuccessHandler(handleResponse)
        .withFailureHandler(handleError)
        .processQuery(message);
    }

    function addMessage(content, type) {
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = content;

      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);

      scrollToBottom();
    }

    function addAIResponse(result) {
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ai';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      // Badge
      const badge = document.createElement('div');
      badge.className = 'response-type-badge';
      badge.textContent = 'üìä –ê–Ω–∞–ª–∏–∑';
      bubble.appendChild(badge);

      // Summary
      if (result.summary) {
        const summary = document.createElement('div');
        summary.className = 'result-summary';
        summary.textContent = result.summary;
        bubble.appendChild(summary);
      }

      // Methodology
      if (result.methodology) {
        const method = document.createElement('div');
        method.className = 'methodology';
        method.textContent = 'üí° ' + result.methodology;
        bubble.appendChild(method);
      }

      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);

      scrollToBottom();
    }

    function addLoadingIndicator(message = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...') {
      const container = document.getElementById('chatContainer');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message ai';
      loadingDiv.id = 'loading';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      const dots = document.createElement('div');
      dots.className = 'loading-dots';
      dots.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';

      const text = document.createElement('div');
      text.className = 'loading-text';
      text.textContent = message;

      bubble.appendChild(dots);
      bubble.appendChild(text);
      loadingDiv.appendChild(bubble);
      container.appendChild(loadingDiv);

      scrollToBottom();
    }

    function removeLoadingIndicator() {
      const loading = document.getElementById('loading');
      if (loading) loading.remove();
    }

    function handleResponse(result) {
      removeLoadingIndicator();
      addAIResponse(result);
      isProcessing = false;
    }

    function handleError(error) {
      removeLoadingIndicator();
      addMessage('‚ùå –û—à–∏–±–∫–∞: ' + (error.message || error), 'ai');
      isProcessing = false;
    }

    function scrollToBottom() {
      const container = document.getElementById('chatContainer');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function formatTimeAgo(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);

      if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω`;
      if (diff < 86400) return `${Math.floor(diff / 3600)} —á`;
      return `${Math.floor(diff / 86400)} –¥–Ω`;
    }

    // Load history on start
    loadHistory();
  </script>
</body>
</html>
