<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      font-size: 14px;
      line-height: 1.6;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-weight: 400;
    }

    /* === Header === */
    .header {
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
      padding: 12px 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 3px;
      letter-spacing: -0.02em;
    }

    .header p {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.92;
    }

    /* === Chat Container === */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* === Messages === */
    .message {
      display: flex;
      gap: 8px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.ai {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.5;
    }

    .message.user .message-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .message.ai .message-bubble {
      background: white;
      color: #202124;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    /* === AI Response Types === */
    .response-type-badge {
      display: inline-block;
      font-size: 10px;
      padding: 3px 9px;
      border-radius: 8px;
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .response-type-formula {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .response-type-analysis {
      background: #e3f2fd;
      color: #1565c0;
    }

    .response-type-action {
      background: #fff3e0;
      color: #e65100;
    }

    .response-type-success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .response-type-warning {
      background: #fff9c4;
      color: #f57f17;
    }

    .formula-code {
      background: #f5f5f5;
      padding: 8px 12px;
      border-radius: 6px;
      font-family: 'Courier New', 'Monaco', monospace;
      font-size: 13px;
      margin: 8px 0;
      border-left: 3px solid #667eea;
      word-break: break-all;
      font-weight: 500;
      line-height: 1.5;
    }

    .insights-list {
      margin: 6px 0;
      padding-left: 16px;
    }

    .insights-list li {
      margin: 4px 0;
      color: #555;
      line-height: 1.6;
    }

    .action-buttons {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      background: #f1f3f4;
      border: none;
      padding: 7px 13px;
      border-radius: 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      color: #5f6368;
      font-weight: 500;
      letter-spacing: -0.01em;
    }

    .action-btn:hover {
      background: #e8eaed;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
    }

    .action-btn.primary:hover {
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      transform: translateY(-1px);
    }

    /* === Input Area === */
    .input-container {
      flex-shrink: 0;
      padding: 10px 14px;
      background: white;
      border-top: 1px solid #e0e0e0;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }

    .input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      border: 1px solid #dadce0;
      border-radius: 24px;
      padding: 10px 16px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      transition: all 0.2s;
    }

    #messageInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    }

    #sendBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    #sendBtn:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transform: scale(1.05);
    }

    #sendBtn:disabled {
      background: #dadce0;
      cursor: not-allowed;
      transform: scale(1);
    }

    /* === Loading === */
    .loading-indicator {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
    }

    .loading-dots {
      display: flex;
      gap: 4px;
      justify-content: center;
    }

    .loading-dot {
      width: 8px;
      height: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .loading-text {
      font-size: 12px;
      color: #5f6368;
      text-align: center;
      font-style: italic;
    }

    .progress-bar-container {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      border-radius: 2px;
      box-shadow: 0 0 8px rgba(102, 126, 234, 0.4);
    }

    .loading-step {
      font-size: 11px;
      color: #5f6368;
      text-align: center;
      margin-top: 4px;
    }

    /* === Empty State === */
    .empty-state {
      text-align: center;
      padding: 24px 16px;
      color: #5f6368;
    }

    .empty-state-icon {
      font-size: 42px;
      margin-bottom: 10px;
    }

    .empty-state h2 {
      font-size: 19px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #202124;
      letter-spacing: -0.02em;
    }

    .empty-state p {
      font-size: 14px;
      font-weight: 400;
      margin-bottom: 14px;
      color: #5f6368;
    }

    .example-queries {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-width: 280px;
      margin: 0 auto;
    }

    .example-query {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .example-query:hover {
      background: #f8f9fa;
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
      transform: translateX(4px);
    }

    /* === Scrollbar === */
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: #dadce0;
      border-radius: 3px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
      background: #bdc1c6;
    }

    /* === Action Preview Form === */
    .action-preview {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      border-left: 3px solid #4285f4;
    }

    .form-field {
      margin-bottom: 10px;
    }

    .form-field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #202124;
      margin-bottom: 5px;
      letter-spacing: 0.01em;
    }

    .form-field input,
    .form-field select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: white;
      transition: border-color 0.2s;
    }

    .form-field input:focus,
    .form-field select:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }

    .form-field-hint {
      font-size: 11px;
      color: #5f6368;
      margin-top: 4px;
    }

    .preview-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .preview-btn-execute {
      flex: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 11px 18px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
      letter-spacing: 0.01em;
    }

    .preview-btn-execute:hover {
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      transform: translateY(-1px);
    }

    .preview-btn-cancel {
      background: #f1f3f4;
      color: #5f6368;
      border: none;
      padding: 11px 18px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.01em;
    }

    .preview-btn-cancel:hover {
      background: #e8eaed;
    }

    /* === Action History Panel === */
    .history-panel {
      background: white;
      border-top: 1px solid #e0e0e0;
      max-height: 200px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .history-header {
      padding: 8px 12px;
      background: #f8f9fa;
      font-size: 12px;
      font-weight: 600;
      color: #202124;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      user-select: none;
      letter-spacing: 0.01em;
    }

    .history-header:hover {
      background: #f1f3f4;
    }

    .history-toggle {
      font-size: 10px;
      color: #5f6368;
    }

    .history-content {
      max-height: 160px;
      overflow-y: auto;
    }

    .history-content.collapsed {
      display: none;
    }

    .history-item {
      padding: 8px 12px;
      border-bottom: 1px solid #f1f3f4;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .history-item:hover {
      background: #f8f9fa;
    }

    .history-item-info {
      flex: 1;
      font-size: 12px;
    }

    .history-item-type {
      font-weight: 500;
      font-size: 13px;
      color: #202124;
      margin-bottom: 3px;
      line-height: 1.4;
    }

    .history-item-time {
      font-size: 11px;
      font-weight: 400;
      color: #80868b;
    }

    .history-item-actions {
      display: flex;
      gap: 4px;
    }

    .history-undo-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .history-undo-btn:hover {
      background: #d32f2f;
    }

    .history-undo-btn:disabled {
      background: #dadce0;
      cursor: not-allowed;
    }

    .history-empty {
      padding: 16px;
      text-align: center;
      font-size: 12px;
      color: #5f6368;
      font-style: italic;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>üí¨ SheetGPT AI</h1>
    <p>–£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ç–∞–±–ª–∏—Ü</p>
  </div>

  <!-- Chat Container -->
  <div class="chat-container" id="chatContainer">
    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
      <div class="empty-state-icon">üëã</div>
      <h2>–ü—Ä–∏–≤–µ—Ç! –Ø SheetGPT</h2>
      <p style="margin-bottom: 16px;">–í–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏</p>

      <div style="text-align: left; max-width: 280px; margin: 0 auto 20px;">
        <p style="font-weight: 500; margin-bottom: 8px;">–ß—Ç–æ —è —É–º–µ—é:</p>
        <ul style="list-style: none; padding: 0; font-size: 13px; line-height: 1.8;">
          <li>üìù –°–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</li>
          <li>üìä –°—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã</li>
          <li>üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</li>
          <li>‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—ã–¥–µ–ª—è—Ç—å —è—á–µ–π–∫–∏</li>
        </ul>
      </div>

      <p style="font-weight: 500; font-size: 13px; margin-bottom: 12px;">–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</p>
      <div class="example-queries">
        <div class="example-query" onclick="useExample('–¢–æ–ø 3 —Ç–æ–≤–∞—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º')">
          üí¨ –¢–æ–ø 3 —Ç–æ–≤–∞—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
        </div>
        <div class="example-query" onclick="useExample('–ü–æ—Å—á–∏—Ç–∞–π —Å—É–º–º—É –≤ —Å—Ç–æ–ª–±—Ü–µ E')">
          üí¨ –ü–æ—Å—á–∏—Ç–∞–π —Å—É–º–º—É –≤ —Å—Ç–æ–ª–±—Ü–µ E
        </div>
        <div class="example-query" onclick="useExample('–ü–æ—Å—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂ –ø–æ –º–µ—Å—è—Ü–∞–º')">
          üí¨ –ü–æ—Å—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂
        </div>
        <div class="example-query" onclick="useExample('–í—ã–¥–µ–ª–∏ –∂–µ–ª—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏—è –±–æ–ª—å—à–µ 100000')">
          üí¨ –í—ã–¥–µ–ª–∏ –∂–µ–ª—Ç—ã–º –±–æ–ª—å—à–µ 100000
        </div>
      </div>
    </div>

    <!-- Messages will be added here dynamically -->
  </div>

  <!-- Action History Panel -->
  <div class="history-panel" id="historyPanel" style="display: none;">
    <div class="history-header" onclick="toggleHistory()">
      <span>üìú –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π (<span id="historyCount">0</span>)</span>
      <span class="history-toggle" id="historyToggle">‚ñº</span>
    </div>
    <div class="history-content" id="historyContent">
      <div class="history-empty">–ü–æ–∫–∞ –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-container">
    <div class="input-wrapper">
      <textarea
        id="messageInput"
        placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-—Ç–æ –æ –¥–∞–Ω–Ω—ã—Ö..."
        rows="3"
        onkeydown="handleKeyPress(event)"
      ></textarea>
      <button id="sendBtn" onclick="sendMessage()" disabled>
        ‚û§
      </button>
    </div>
  </div>

  <script>
    let chatHistory = [];
    let isProcessing = false;
    let actionHistory = []; // –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    let actionIdCounter = 0; // –°—á–µ—Ç—á–∏–∫ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID –¥–µ–π—Å—Ç–≤–∏–π
    let lastQuery = ''; // –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –¥–ª—è retry

    console.log('üîß Sidebar.html –∑–∞–≥—Ä—É–∂–µ–Ω, –≤–µ—Ä—Å–∏—è —Å DEBUG');

    // Initialize
    document.getElementById('messageInput').addEventListener('input', function() {
      console.log('üìù Input changed, value:', this.value);
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';

      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = !this.value.trim() || isProcessing;
      console.log('Button disabled:', sendBtn.disabled);
    });

    /**
     * –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥–∞—á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ google.script.run
     */
    function runDiagnosticTest() {
      console.log('üß™ ========== –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –¢–ï–°–¢ START ==========');

      const testString = '–¢–ï–°–¢–û–í–ê–Ø –°–¢–†–û–ö–ê 123';
      console.log('üß™ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ç—Ä–æ–∫—É:', testString);
      console.log('üß™ –¢–∏–ø:', typeof testString);
      console.log('üß™ –î–ª–∏–Ω–∞:', testString.length);

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
      addMessage('üß™ –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞...', 'user');

      try {
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('üß™ ‚úÖ SUCCESS handler –≤—ã–∑–≤–∞–Ω');
            console.log('üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç:', result);

            if (result.success) {
              const msg = `‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù!\n\n–ü–∞—Ä–∞–º–µ—Ç—Ä —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω:\n- –ü–æ–ª—É—á–µ–Ω–æ: "${result.received}"\n- –¢–∏–ø: ${result.type}\n- –î–ª–∏–Ω–∞: ${result.length}`;
              addMessage(msg, 'ai');
              console.log('üß™ ‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
            } else {
              const msg = `‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù!\n\n–û—à–∏–±–∫–∞: ${result.error}\n${result.message}`;
              addMessage(msg, 'ai');
              console.error('üß™ ‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù:', result.error, result.message);
            }
          })
          .withFailureHandler(function(error) {
            console.error('üß™ ‚ùå FAILURE handler –≤—ã–∑–≤–∞–Ω');
            console.error('üß™ Error:', error);
            addMessage(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`, 'ai');
          })
          .simpleEcho(testString);

        console.log('üß™ google.script.run.simpleEcho() –≤—ã–∑–≤–∞–Ω');
      } catch (error) {
        console.error('üß™ ‚ùå EXCEPTION –ø—Ä–∏ –≤—ã–∑–æ–≤–µ google.script.run:');
        console.error(error);
        addMessage(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'ai');
      }

      console.log('üß™ ========== –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –¢–ï–°–¢ END ==========');
    }

    function handleKeyPress(event) {
      console.log('‚å®Ô∏è Key pressed:', event.key, 'Shift:', event.shiftKey);
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        console.log('‚úÖ Enter pressed without Shift, calling sendMessage()');
        sendMessage();
      }
    }

    function useExample(query) {
      console.log('üìå Using example query:', query);
      document.getElementById('messageInput').value = query;
      document.getElementById('sendBtn').disabled = false;
      sendMessage();
    }

    function sendMessage() {
      console.log('üîç ========== sendMessage() START ==========');
      console.log('üîç isProcessing:', isProcessing);

      const input = document.getElementById('messageInput');
      console.log('üîç Input element:', input);
      console.log('üîç Input element exists:', !!input);

      if (!input) {
        console.error('‚ùå Input element not found!');
        alert('–û–®–ò–ë–ö–ê: –≠–ª–µ–º–µ–Ω—Ç –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }

      console.log('üîç Input.value:', input.value);
      console.log('üîç Input.value type:', typeof input.value);

      const message = input.value.trim();
      console.log('üîç Message after trim:', message);
      console.log('üîç Message type:', typeof message);
      console.log('üîç Message length:', message.length);
      console.log('üîç Message is empty:', !message);

      if (!message || isProcessing) {
        console.warn('‚ö†Ô∏è Cannot send message:');
        console.warn('  - Message empty:', !message);
        console.warn('  - isProcessing:', isProcessing);
        return;
      }

      // Save last query for retry
      lastQuery = message;

      console.log('‚úÖ All checks passed, proceeding...');

      // Hide empty state
      const emptyState = document.getElementById('emptyState');
      console.log('üîç Empty state element:', emptyState);
      if (emptyState) {
        emptyState.style.display = 'none';
        console.log('‚úÖ Empty state hidden');
      }

      // Add user message
      console.log('üì§ Adding user message to chat...');
      addMessage(message, 'user');

      // Clear input
      input.value = '';
      input.style.height = 'auto';
      document.getElementById('sendBtn').disabled = true;
      console.log('‚úÖ Input cleared');

      // Show loading
      isProcessing = true;
      console.log('‚úÖ isProcessing set to true');
      addLoadingIndicator();

      console.log('üì° Calling google.script.run.processQuery()');
      console.log('üì° Message to send:', message);
      console.log('üì° Message type:', typeof message);

      // Call backend
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('‚úÖ SUCCESS handler called');
            console.log('Result:', result);
            handleResponse(result);
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå FAILURE handler called');
            console.error('Error:', error);
            handleError(error);
          })
          .setQueryAndProcess(message);

        console.log('‚úÖ google.script.run.setQueryAndProcess called successfully');
      } catch (error) {
        console.error('‚ùå EXCEPTION in google.script.run:');
        console.error(error);
        alert('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ' + error.message);
      }

      console.log('üîç ========== sendMessage() END ==========');
    }

    function addMessage(content, type) {
      console.log('üí¨ addMessage called:', type, content);
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = content;

      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);

      scrollToBottom();
    }

    function addAIResponse(result) {
      console.log('ü§ñ addAIResponse called:', result);
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ai';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      // Response type badge
      const responseType = result.response_type || 'formula';
      const badge = document.createElement('div');
      badge.className = `response-type-badge response-type-${responseType}`;
      if (responseType === 'analysis') {
        badge.textContent = 'üìä –ê–Ω–∞–ª–∏–∑';
      } else if (responseType === 'action') {
        badge.textContent = 'üéØ –î–µ–π—Å—Ç–≤–∏—è';
        badge.className = 'response-type-badge response-type-formula';
      } else {
        badge.textContent = 'üìù –§–æ—Ä–º—É–ª–∞';
      }
      bubble.appendChild(badge);

      // Main content
      const content = document.createElement('div');

      if (responseType === 'formula' && result.formula) {
        // Formula
        const formulaDiv = document.createElement('div');
        formulaDiv.className = 'formula-code';
        formulaDiv.textContent = result.formula;
        content.appendChild(formulaDiv);

        // Explanation
        const explanation = document.createElement('p');
        explanation.textContent = result.explanation;
        content.appendChild(explanation);

        // Action buttons
        const actions = document.createElement('div');
        actions.className = 'action-buttons';

        const insertBtn = document.createElement('button');
        insertBtn.className = 'action-btn primary';
        insertBtn.textContent = '‚úì –í—Å—Ç–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É';
        insertBtn.onclick = () => insertFormula(result.formula, result.target_cell);
        actions.appendChild(insertBtn);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'action-btn';
        copyBtn.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
        copyBtn.onclick = () => copyToClipboard(result.formula);
        actions.appendChild(copyBtn);

        content.appendChild(actions);
      } else if (responseType === 'action' && result.insights) {
        // Action Plan - Show interactive preview
        const explanation = document.createElement('p');
        explanation.textContent = result.explanation;
        explanation.style.marginBottom = '8px';
        content.appendChild(explanation);

        // Create editable preview for each action
        if (result.insights && result.insights.length > 0) {
          result.insights.forEach((action, index) => {
            const previewDiv = createActionPreview(action, index, result.insights);
            content.appendChild(previewDiv);
          });
        }
      } else {
        // Analysis
        if (result.summary) {
          const summaryDiv = document.createElement('div');
          summaryDiv.style.padding = '10px';
          summaryDiv.style.backgroundColor = '#f5f5f5';
          summaryDiv.style.borderRadius = '6px';
          summaryDiv.style.marginBottom = '12px';
          summaryDiv.style.fontWeight = '500';
          summaryDiv.innerHTML = `<strong>üìä –í—ã–≤–æ–¥:</strong><br>${result.summary}`;
          content.appendChild(summaryDiv);
        } else if (result.explanation || result.answer) {
          const answer = document.createElement('p');
          answer.textContent = result.explanation || result.answer;
          content.appendChild(answer);
        }

        // Methodology - how the calculation was done
        if (result.methodology) {
          const methodDiv = document.createElement('div');
          methodDiv.style.padding = '8px 10px';
          methodDiv.style.backgroundColor = '#e3f2fd';
          methodDiv.style.borderRadius = '6px';
          methodDiv.style.marginBottom = '12px';
          methodDiv.style.fontSize = '12px';
          methodDiv.style.color = '#1565c0';
          methodDiv.style.borderLeft = '3px solid #1976d2';
          methodDiv.textContent = result.methodology;
          content.appendChild(methodDiv);
        }

        if (result.key_findings && result.key_findings.length > 0) {
          const findingsTitle = document.createElement('p');
          findingsTitle.style.marginTop = '12px';
          findingsTitle.style.fontWeight = '600';
          findingsTitle.style.marginBottom = '6px';
          findingsTitle.textContent = 'üîç –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:';
          content.appendChild(findingsTitle);

          const findingsList = document.createElement('ul');
          findingsList.className = 'insights-list';
          findingsList.style.listStyle = 'none';
          findingsList.style.padding = '0';
          result.key_findings.forEach(finding => {
            const li = document.createElement('li');
            li.style.padding = '6px 0';
            li.style.borderBottom = '1px solid #eee';
            li.textContent = finding;
            findingsList.appendChild(li);
          });
          content.appendChild(findingsList);
        }

        if (result.insights && result.insights.length > 0) {
          const insightsTitle = document.createElement('p');
          insightsTitle.style.marginTop = '12px';
          insightsTitle.style.fontWeight = '600';
          insightsTitle.style.marginBottom = '6px';
          insightsTitle.textContent = 'üí° –ò–Ω—Å–∞–π—Ç—ã:';
          content.appendChild(insightsTitle);

          const insightsList = document.createElement('ul');
          insightsList.className = 'insights-list';
          insightsList.style.listStyle = 'none';
          insightsList.style.padding = '0';
          result.insights.forEach(insight => {
            const li = document.createElement('li');
            li.style.padding = '6px 0';

            if (typeof insight === 'object') {
              if (insight.type === 'create_chart') {
                li.textContent = `üìä –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫: ${insight.config.title || '–ì—Ä–∞—Ñ–∏–∫ –¥–∞–Ω–Ω—ã—Ö'}`;
              } else {
                li.textContent = `${insight.type}: ${JSON.stringify(insight.config || insight)}`;
              }
            } else {
              li.textContent = insight;
            }
            insightsList.appendChild(li);
          });
          content.appendChild(insightsList);
        }

        if (result.suggested_actions && result.suggested_actions.length > 0) {
          const actionsTitle = document.createElement('p');
          actionsTitle.style.marginTop = '12px';
          actionsTitle.style.fontWeight = '600';
          actionsTitle.style.marginBottom = '6px';
          actionsTitle.textContent = '‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:';
          content.appendChild(actionsTitle);

          const actionsList = document.createElement('ul');
          actionsList.className = 'insights-list';
          actionsList.style.listStyle = 'none';
          actionsList.style.padding = '0';
          actionsList.style.backgroundColor = '#e8f5e9';
          actionsList.style.padding = '8px';
          actionsList.style.borderRadius = '6px';
          result.suggested_actions.forEach(action => {
            const li = document.createElement('li');
            li.style.padding = '4px 0';
            li.textContent = action;
            actionsList.appendChild(li);
          });
          content.appendChild(actionsList);
        }
      }

      bubble.appendChild(content);
      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);

      scrollToBottom();
    }

    /**
     * Creates interactive preview form for action
     */
    function createActionPreview(action, index, allActions) {
      const previewDiv = document.createElement('div');
      previewDiv.className = 'action-preview';
      previewDiv.id = `action-preview-${index}`;

      // Action type header
      const header = document.createElement('div');
      header.style.fontWeight = '500';
      header.style.marginBottom = '12px';
      header.style.fontSize = '14px';

      if (action.type === 'create_chart') {
        header.innerHTML = 'üìä –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫';

        // Title field
        const titleField = document.createElement('div');
        titleField.className = 'form-field';
        titleField.innerHTML = `
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞</label>
          <input type="text" id="chart-title-${index}" value="${action.config.title || '–ì—Ä–∞—Ñ–∏–∫'}" />
        `;
        previewDiv.appendChild(header);
        previewDiv.appendChild(titleField);

        // Data range field
        const rangeField = document.createElement('div');
        rangeField.className = 'form-field';
        rangeField.innerHTML = `
          <label>–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö</label>
          <input type="text" id="chart-range-${index}" value="${action.config.dataRange || 'A1:B10'}" />
          <div class="form-field-hint">–ù–∞–ø—Ä–∏–º–µ—Ä: A2:D4</div>
        `;
        previewDiv.appendChild(rangeField);

        // Chart type selector
        const typeField = document.createElement('div');
        typeField.className = 'form-field';
        const chartType = action.config.type || 'bar';
        typeField.innerHTML = `
          <label>–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞</label>
          <select id="chart-type-${index}">
            <option value="bar" ${chartType === 'bar' ? 'selected' : ''}>üìä –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</option>
            <option value="column" ${chartType === 'column' ? 'selected' : ''}>üìä –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã</option>
            <option value="line" ${chartType === 'line' ? 'selected' : ''}>üìà –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫</option>
            <option value="pie" ${chartType === 'pie' ? 'selected' : ''}>ü•ß –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</option>
            <option value="area" ${chartType === 'area' ? 'selected' : ''}>üìâ –ì—Ä–∞—Ñ–∏–∫ —Å –æ–±–ª–∞—Å—Ç—å—é</option>
          </select>
        `;
        previewDiv.appendChild(typeField);

      } else if (action.type === 'format_cells') {
        header.innerHTML = 'üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —è—á–µ–π–∫–∏';

        const rangeField = document.createElement('div');
        rangeField.className = 'form-field';
        rangeField.innerHTML = `
          <label>–î–∏–∞–ø–∞–∑–æ–Ω —è—á–µ–µ–∫</label>
          <input type="text" id="format-range-${index}" value="${action.config.range || 'A1:A10'}" />
        `;
        previewDiv.appendChild(header);
        previewDiv.appendChild(rangeField);

      } else if (action.type === 'insert_formula') {
        header.innerHTML = 'üìù –í—Å—Ç–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É';

        const formulaField = document.createElement('div');
        formulaField.className = 'form-field';
        formulaField.innerHTML = `
          <label>–§–æ—Ä–º—É–ª–∞</label>
          <input type="text" id="formula-${index}" value="${action.config.formula || ''}" />
        `;
        previewDiv.appendChild(header);
        previewDiv.appendChild(formulaField);

      } else {
        // Generic action
        header.innerHTML = `${action.type}`;
        previewDiv.appendChild(header);
      }

      // Action buttons
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'preview-actions';

      const executeBtn = document.createElement('button');
      executeBtn.className = 'preview-btn-execute';
      executeBtn.textContent = '‚úì –í—ã–ø–æ–ª–Ω–∏—Ç—å';
      executeBtn.onclick = () => {
        // Disable button and show loading state
        executeBtn.disabled = true;
        executeBtn.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
        cancelBtn.disabled = true;

        // Update action config with edited values
        const updatedAction = { ...action };

        if (action.type === 'create_chart') {
          const title = document.getElementById(`chart-title-${index}`).value;
          const range = document.getElementById(`chart-range-${index}`).value;
          const type = document.getElementById(`chart-type-${index}`).value;
          updatedAction.config = {
            ...action.config,
            title: title,
            dataRange: range,
            type: type
          };
        } else if (action.type === 'format_cells') {
          const range = document.getElementById(`format-range-${index}`).value;
          updatedAction.config = {
            ...action.config,
            range: range
          };
        } else if (action.type === 'insert_formula') {
          const formula = document.getElementById(`formula-${index}`).value;
          updatedAction.config = {
            ...action.config,
            formula: formula
          };
        }

        // Execute single action with progress tracking
        executeActionsWithProgress([updatedAction], (success) => {
          if (success) {
            previewDiv.innerHTML = '<p style="color: #0f9d58; font-weight: 500;">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ</p>';
          } else {
            previewDiv.innerHTML = '<p style="color: #f44336; font-weight: 500;">‚úó –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</p>';
          }
        });
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'preview-btn-cancel';
      cancelBtn.textContent = '‚úï –û—Ç–º–µ–Ω–∏—Ç—å';
      cancelBtn.onclick = () => {
        previewDiv.innerHTML = '<p style="color: #5f6368; font-style: italic;">–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ</p>';
      };

      actionsDiv.appendChild(executeBtn);
      actionsDiv.appendChild(cancelBtn);
      previewDiv.appendChild(actionsDiv);

      return previewDiv;
    }

    function addLoadingIndicator(message = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...', showProgress = false) {
      console.log('‚è≥ Adding loading indicator...');
      const container = document.getElementById('chatContainer');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message ai';
      loadingDiv.id = 'loading';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      const loading = document.createElement('div');
      loading.className = 'loading-indicator';

      // Dots
      const dotsDiv = document.createElement('div');
      dotsDiv.className = 'loading-dots';
      dotsDiv.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';
      loading.appendChild(dotsDiv);

      // Text
      const textDiv = document.createElement('div');
      textDiv.className = 'loading-text';
      textDiv.id = 'loading-text';
      textDiv.textContent = message;
      loading.appendChild(textDiv);

      // Progress bar (optional)
      if (showProgress) {
        const progressContainer = document.createElement('div');
        progressContainer.className = 'progress-bar-container';
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        progressBar.id = 'progress-bar';
        progressBar.style.width = '0%';
        progressContainer.appendChild(progressBar);
        loading.appendChild(progressContainer);

        const stepDiv = document.createElement('div');
        stepDiv.className = 'loading-step';
        stepDiv.id = 'loading-step';
        stepDiv.textContent = '';
        loading.appendChild(stepDiv);
      }

      bubble.appendChild(loading);
      loadingDiv.appendChild(bubble);
      container.appendChild(loadingDiv);

      scrollToBottom();
    }

    function updateLoadingProgress(percent, step) {
      const progressBar = document.getElementById('progress-bar');
      const stepDiv = document.getElementById('loading-step');
      const textDiv = document.getElementById('loading-text');

      if (progressBar) {
        progressBar.style.width = percent + '%';
      }
      if (stepDiv && step) {
        stepDiv.textContent = step;
      }
      if (textDiv && step) {
        textDiv.textContent = step;
      }
    }

    function removeLoadingIndicator() {
      console.log('‚è≥ Removing loading indicator...');
      const loading = document.getElementById('loading');
      if (loading) loading.remove();
    }

    function handleResponse(result) {
      console.log('‚úÖ handleResponse called:', result);
      removeLoadingIndicator();
      addAIResponse(result);
      isProcessing = false;
    }

    function handleError(error) {
      console.error('‚ùå handleError called:', error);
      removeLoadingIndicator();

      const container = document.getElementById('chatContainer');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'message ai';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.style.borderLeft = '3px solid #f44336';

      // Parse error and create user-friendly message
      const errorInfo = parseError(error);

      bubble.innerHTML = `
        <div style="margin-bottom: 8px;">
          <span style="color: #f44336; font-weight: 600; font-size: 13px;">‚ö†Ô∏è ${errorInfo.title}</span>
        </div>
        <p style="font-size: 13px; color: #5f6368; line-height: 1.6; margin-bottom: 10px;">
          ${errorInfo.message}
        </p>
        ${errorInfo.suggestion ? `
          <div style="background: #fff9c4; padding: 8px 10px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
            üí° <strong>–°–æ–≤–µ—Ç:</strong> ${errorInfo.suggestion}
          </div>
        ` : ''}
        <div style="margin-top: 10px;">
          <button onclick="retryLastQuery()" class="action-btn" style="background: #667eea; color: white; font-size: 12px; padding: 6px 12px;">
            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
          </button>
        </div>
      `;

      errorDiv.appendChild(bubble);
      container.appendChild(errorDiv);

      scrollToBottom();
      isProcessing = false;
    }

    /**
     * Parse error into user-friendly format
     */
    function parseError(error) {
      const errorStr = error.message || error.toString();

      // Timeout errors
      if (errorStr.includes('timed out') || errorStr.includes('timeout')) {
        return {
          title: '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è',
          message: '–°–µ—Ä–≤–µ—Ä –Ω–µ —É—Å–ø–µ–ª –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –í–æ–∑–º–æ–∂–Ω–æ, –¥–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω.',
          suggestion: '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥'
        };
      }

      // Permission errors
      if (errorStr.includes('permission') || errorStr.includes('Authorization')) {
        return {
          title: '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞',
          message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.',
          suggestion: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è SheetGPT –≤ –º–µ–Ω—é –†–∞—Å—à–∏—Ä–µ–Ω–∏—è'
        };
      }

      // Network errors
      if (errorStr.includes('network') || errorStr.includes('fetch')) {
        return {
          title: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏',
          message: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.',
          suggestion: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É'
        };
      }

      // Data validation errors
      if (errorStr.includes('validation') || errorStr.includes('invalid')) {
        return {
          title: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
          message: '–î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É.',
          suggestion: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã–±—Ä–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω —Å –¥–∞–Ω–Ω—ã–º–∏'
        };
      }

      // Default error
      return {
        title: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞',
        message: errorStr.replace(/^(ScriptError: Error: |Error: )/, ''),
        suggestion: '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö'
      };
    }

    /**
     * Retry last query
     */
    function retryLastQuery() {
      if (lastQuery) {
        document.getElementById('messageInput').value = lastQuery;
        sendMessage();
      }
    }

    function scrollToBottom() {
      const container = document.getElementById('chatContainer');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function insertFormula(formula, targetCell) {
      console.log('üìù Inserting formula:', formula, 'to cell:', targetCell);
      google.script.run
        .withSuccessHandler(() => {
          alert('‚úì –§–æ—Ä–º—É–ª–∞ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞!');
        })
        .withFailureHandler((error) => {
          alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        })
        .insertFormula(formula, targetCell);
    }

    function copyToClipboard(text) {
      console.log('üìã Copying to clipboard:', text);
      navigator.clipboard.writeText(text).then(() => {
        alert('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
      }).catch(() => {
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      });
    }

    function executeActions(actions) {
      console.log('‚ñ∂ Executing actions:', actions);
      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            // Add successful actions to history
            actions.forEach((action, index) => {
              if (result.results[index] && result.results[index].success) {
                addToHistory(action, result.results[index]);
              }
            });

            alert(`‚úì –£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ${result.results.filter(r => r.success).length}/${result.results.length} –¥–µ–π—Å—Ç–≤–∏–π`);
          } else {
            alert('‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.');
          }
        })
        .withFailureHandler((error) => {
          alert('‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ' + error.message);
        })
        .executeActions(actions);
    }

    /**
     * Execute actions with progress tracking
     */
    function executeActionsWithProgress(actions, callback) {
      console.log('‚ñ∂ Executing actions with progress:', actions);

      // Show progress indicator for multiple actions
      const showProgress = actions.length > 1;
      if (showProgress) {
        addLoadingIndicator('–í—ã–ø–æ–ª–Ω—è—é –¥–µ–π—Å—Ç–≤–∏—è...', true);
      }

      google.script.run
        .withSuccessHandler((result) => {
          if (showProgress) {
            removeLoadingIndicator();
          }

          if (result.success) {
            // Add successful actions to history
            actions.forEach((action, index) => {
              if (result.results[index] && result.results[index].success) {
                addToHistory(action, result.results[index]);
              }
            });

            if (callback) {
              callback(true);
            } else {
              alert(`‚úì –£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ${result.results.filter(r => r.success).length}/${result.results.length} –¥–µ–π—Å—Ç–≤–∏–π`);
            }
          } else {
            if (callback) {
              callback(false);
            } else {
              alert('‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.');
            }
          }
        })
        .withFailureHandler((error) => {
          if (showProgress) {
            removeLoadingIndicator();
          }

          if (callback) {
            callback(false);
          } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ' + error.message);
          }
        })
        .executeActions(actions);

      // Simulate progress updates for multiple actions
      if (showProgress && actions.length > 1) {
        let currentStep = 0;
        const stepInterval = setInterval(() => {
          currentStep++;
          const percent = Math.min((currentStep / actions.length) * 100, 90);
          const stepText = `–í—ã–ø–æ–ª–Ω—è—é ${currentStep}/${actions.length}...`;
          updateLoadingProgress(percent, stepText);

          if (currentStep >= actions.length) {
            clearInterval(stepInterval);
            updateLoadingProgress(100, '–ó–∞–≤–µ—Ä—à–∞—é...');
          }
        }, 1000);
      }
    }

    /**
     * Toggle history panel collapsed/expanded
     */
    function toggleHistory() {
      const content = document.getElementById('historyContent');
      const toggle = document.getElementById('historyToggle');

      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggle.textContent = '‚ñº';
      } else {
        content.classList.add('collapsed');
        toggle.textContent = '‚ñ∂';
      }
    }

    /**
     * Add action to history
     */
    function addToHistory(action, result) {
      const historyItem = {
        id: actionIdCounter++,
        action: action,
        result: result,
        timestamp: new Date(),
        canUndo: action.type === 'create_chart' || action.type === 'format_cells'
      };

      actionHistory.push(historyItem);
      updateHistoryUI();

      // Show history panel if hidden
      const panel = document.getElementById('historyPanel');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
      }
    }

    /**
     * Update history UI
     */
    function updateHistoryUI() {
      const content = document.getElementById('historyContent');
      const count = document.getElementById('historyCount');

      count.textContent = actionHistory.length;

      if (actionHistory.length === 0) {
        content.innerHTML = '<div class="history-empty">–ü–æ–∫–∞ –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</div>';
        return;
      }

      // Render history items (newest first)
      content.innerHTML = '';
      const reversedHistory = [...actionHistory].reverse();

      reversedHistory.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'history-item';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'history-item-info';

        const typeDiv = document.createElement('div');
        typeDiv.className = 'history-item-type';

        // Action type label
        let typeLabel = '';
        let typeIcon = '';
        if (item.action.type === 'create_chart') {
          typeIcon = 'üìä';
          typeLabel = `–ì—Ä–∞—Ñ–∏–∫: ${item.action.config.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}`;
        } else if (item.action.type === 'format_cells') {
          typeIcon = 'üé®';
          typeLabel = `–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${item.action.config.range || '–î–∏–∞–ø–∞–∑–æ–Ω'}`;
        } else if (item.action.type === 'insert_formula') {
          typeIcon = 'üìù';
          typeLabel = `–§–æ—Ä–º—É–ª–∞ –≤ ${item.action.config.targetCell || '—è—á–µ–π–∫—É'}`;
        } else {
          typeIcon = '‚öôÔ∏è';
          typeLabel = item.action.type;
        }

        typeDiv.textContent = `${typeIcon} ${typeLabel}`;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'history-item-time';
        timeDiv.textContent = formatTime(item.timestamp);

        infoDiv.appendChild(typeDiv);
        infoDiv.appendChild(timeDiv);

        // Actions
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'history-item-actions';

        if (item.canUndo) {
          const undoBtn = document.createElement('button');
          undoBtn.className = 'history-undo-btn';
          undoBtn.textContent = '‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å';
          undoBtn.onclick = () => undoAction(item.id);
          actionsDiv.appendChild(undoBtn);
        }

        itemDiv.appendChild(infoDiv);
        itemDiv.appendChild(actionsDiv);
        content.appendChild(itemDiv);
      });
    }

    /**
     * Format timestamp for display
     */
    function formatTime(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000); // seconds

      if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      if (diff < 86400) return `${Math.floor(diff / 3600)} —á –Ω–∞–∑–∞–¥`;

      return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }

    /**
     * Undo an action
     */
    function undoAction(actionId) {
      const item = actionHistory.find(h => h.id === actionId);
      if (!item) {
        alert('‚ùå –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏');
        return;
      }

      if (!confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ: ${item.action.type}?`)) {
        return;
      }

      console.log('Undoing action:', item);

      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            alert('‚úì –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
            // Mark as undone in history
            item.canUndo = false;
            updateHistoryUI();
          } else {
            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å: ' + (result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        })
        .withFailureHandler((error) => {
          alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ' + error.message);
        })
        .undoAction(item.action, item.result);
    }

    console.log('‚úÖ Sidebar.html initialization complete');
  </script>
</body>
</html>
