#!/usr/bin/env python3
"""
–¢–µ—Å—Ç AI Code Executor - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ø–æ—á–∫—É:
AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ ‚Üí Python –≤—ã–ø–æ–ª–Ω—è–µ—Ç ‚Üí –¢–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), 'backend'))

from backend.app.services.ai_code_executor import AICodeExecutor
import json

def test_code_executor():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
    """

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º executor
    executor = AICodeExecutor()

    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ –¢–æ–≤–∞—Ä 14)
    column_names = ["–ö–æ–ª–æ–Ω–∫–∞ A", "–ö–æ–ª–æ–Ω–∫–∞ B", "–ö–æ–ª–æ–Ω–∫–∞ C", "–ö–æ–ª–æ–Ω–∫–∞ D", "–ö–æ–ª–æ–Ω–∫–∞ E"]
    sheet_data = [
        ["–¢–æ–≤–∞—Ä 1", "–û–û–û –í—Ä–µ–º—è", 10730.32, 1010, 107303.2],
        ["–¢–æ–≤–∞—Ä 2", "–û–û–û –°–∞—Ç—É—Ä–Ω", 8568.37, 1030, 257051.1],
        ["–¢–æ–≤–∞—Ä 3", "–û–û–û –õ—É–Ω–∞", 7318.09, 1020, 146361.8],
        ["–¢–æ–≤–∞—Ä 14", "–û–û–û –í—Ä–µ–º—è", 6328.28, 1007, 44297.96],  # 1
        ["–¢–æ–≤–∞—Ä 5", "–û–û–û –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤", 1196.9, 1017, 20347.3],
        ["–¢–æ–≤–∞—Ä 14", "–û–û–û –í—Ä–µ–º—è", 6328.28, 1023, 145550.44], # 2
        ["–¢–æ–≤–∞—Ä 7", "–û–û–û –ö–æ—Å–º–æ—Å", 2499.28, 1012, 29991.36],
        ["–¢–æ–≤–∞—Ä 8", "–û–û–û –†–∞–¥–æ—Å—Ç—å", 25212.79, 1015, 378191.85],
        ["–¢–æ–≤–∞—Ä 14", "–û–û–û –í—Ä–µ–º—è", 6328.28, 1023, 145550.44], # 3
        ["–¢–æ–≤–∞—Ä 10", "–ò–ü –†–∞–∑—É–º", 17789.22, 1010, 177892.2],
        ["–¢–æ–≤–∞—Ä 14", "–û–û–û –í—Ä–µ–º—è", 6328.28, 1015, 63282.8],  # 4
        ["–¢–æ–≤–∞—Ä 14", "–û–û–û –í—Ä–µ–º—è", 6328.28, 1025, 129076.72], # 5
        ["–¢–æ–≤–∞—Ä 14", "–û–û–û –í—Ä–µ–º—è", 6328.28, 1022, 60771.44], # 6
        ["–¢–æ–≤–∞—Ä 2", "–û–û–û –°–∞—Ç—É—Ä–Ω", 8568.37, 1018, 154230.66], # –ï—â–µ –æ–¥–∏–Ω –¢–æ–≤–∞—Ä 2
    ]

    # –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    test_queries = [
        {
            "query": "–¢–æ–ø 3 —Ç–æ–≤–∞—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º",
            "expected": ["–¢–æ–≤–∞—Ä 14", "588", "–¢–æ–≤–∞—Ä 2", "411", "–¢–æ–≤–∞—Ä 8", "378"]
        },
        {
            "query": "–£ –∫–∞–∫–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂",
            "expected": ["–û–û–û –í—Ä–µ–º—è", "695"]
        },
        {
            "query": "–ü–æ—Å—á–∏—Ç–∞–π –æ–±—â—É—é —Å—É–º–º—É –ø—Ä–æ–¥–∞–∂",
            "expected": ["2103848"]
        },
        {
            "query": "–°–∫–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤",
            "expected": ["8"]
        },
        {
            "query": "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞",
            "expected": ["9405"]
        },
        {
            "query": "–ù–∞–π–¥–∏ —Ç–æ–≤–∞—Ä—ã –¥–µ—à–µ–≤–ª–µ 3000",
            "expected": ["–¢–æ–≤–∞—Ä 5", "–¢–æ–≤–∞—Ä 7"]
        }
    ]

    print("=" * 70)
    print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï AI CODE EXECUTOR")
    print("=" * 70)

    passed = 0
    failed = 0

    for test in test_queries:
        print(f"\n–ó–∞–ø—Ä–æ—Å: {test['query']}")
        print("-" * 50)

        try:
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
            result = executor.process_with_code(
                query=test["query"],
                column_names=column_names,
                sheet_data=sheet_data
            )

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if "error" in result:
                print(f"‚ùå –û–®–ò–ë–ö–ê: {result['error']}")
                failed += 1
            else:
                print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: {result['summary'][:200]}")
                print(f"üìä –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è: {result['methodology'][:100]}")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                summary_lower = result['summary'].lower()
                all_found = True
                for expected in test['expected']:
                    if expected.lower() not in summary_lower:
                        print(f"   ‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω–æ: {expected}")
                        all_found = False

                if all_found:
                    print(f"   ‚úÖ –í—Å–µ –æ–∂–∏–¥–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã")
                    passed += 1
                else:
                    failed += 1

                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ (–ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤)
                if 'code_generated' in result:
                    print(f"üìù –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:")
                    print(f"   {result['code_generated'][:300]}...")

        except Exception as e:
            print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: {str(e)}")
            failed += 1

    # –ò—Ç–æ–≥–∏
    print("\n" + "=" * 70)
    print("–ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø")
    print("=" * 70)
    print(f"‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö: {passed}")
    print(f"‚ùå –ù–µ—É–¥–∞—á–Ω—ã—Ö: {failed}")
    print(f"üìä –¢–æ—á–Ω–æ—Å—Ç—å: {(passed / len(test_queries)) * 100:.1f}%")

    if passed == len(test_queries):
        print("\nüéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
        print("–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Python –∫–æ–¥ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ—á–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è!")
    else:
        print("\n‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏")
        print("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞")

if __name__ == "__main__":
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å API –∫–ª—é—á
    try:
        from backend.app.config import settings
        if not settings.OPENAI_API_KEY:
            print("‚ùå OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
            print("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è: export OPENAI_API_KEY='your-key'")
            exit(1)
    except:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å config")
        print("–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª backend/app/config.py —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        exit(1)

    test_code_executor()