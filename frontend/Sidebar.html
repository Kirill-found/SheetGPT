<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      font-size: 14px;
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* === Header === */
    .header {
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 12px;
      opacity: 0.9;
    }

    /* === Chat Container === */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* === Messages === */
    .message {
      display: flex;
      gap: 8px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.ai {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
    }

    .message.user .message-bubble {
      background: #0f9d58;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.ai .message-bubble {
      background: white;
      color: #202124;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    /* === AI Response Types === */
    .response-type-badge {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .response-type-formula {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .response-type-analysis {
      background: #e3f2fd;
      color: #1565c0;
    }

    .formula-code {
      background: #f5f5f5;
      padding: 8px 12px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 8px 0;
      border-left: 3px solid #0f9d58;
      word-break: break-all;
    }

    .insights-list {
      margin: 8px 0;
      padding-left: 20px;
    }

    .insights-list li {
      margin: 4px 0;
      color: #555;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      background: #f1f3f4;
      border: none;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: #5f6368;
      font-weight: 500;
    }

    .action-btn:hover {
      background: #e8eaed;
    }

    .action-btn.primary {
      background: #0f9d58;
      color: white;
    }

    .action-btn.primary:hover {
      background: #0b8043;
    }

    /* === Input Area === */
    .input-container {
      flex-shrink: 0;
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e0e0e0;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }

    .input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      border: 1px solid #dadce0;
      border-radius: 24px;
      padding: 10px 16px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      transition: all 0.2s;
    }

    #messageInput:focus {
      outline: none;
      border-color: #0f9d58;
      box-shadow: 0 0 0 2px rgba(15, 157, 88, 0.1);
    }

    #sendBtn {
      background: #0f9d58;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    #sendBtn:hover {
      background: #0b8043;
      transform: scale(1.05);
    }

    #sendBtn:disabled {
      background: #dadce0;
      cursor: not-allowed;
      transform: scale(1);
    }

    /* === Loading === */
    .loading-indicator {
      display: flex;
      gap: 4px;
      padding: 12px;
    }

    .loading-dot {
      width: 8px;
      height: 8px;
      background: #0f9d58;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* === Empty State === */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #5f6368;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #202124;
    }

    .empty-state p {
      font-size: 14px;
      margin-bottom: 20px;
    }

    .example-queries {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 280px;
      margin: 0 auto;
    }

    .example-query {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .example-query:hover {
      background: #f8f9fa;
      border-color: #0f9d58;
      transform: translateX(4px);
    }

    /* === Scrollbar === */
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: #dadce0;
      border-radius: 3px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
      background: #bdc1c6;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>üí¨ SheetGPT AI</h1>
    <p>–£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ç–∞–±–ª–∏—Ü</p>
  </div>

  <!-- Chat Container -->
  <div class="chat-container" id="chatContainer">
    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
      <div class="empty-state-icon">ü§ñ</div>
      <h2>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h2>
      <p>–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É</p>

      <div class="example-queries">
        <div class="example-query" onclick="useExample('–¢–æ–ø 3 —Ç–æ–≤–∞—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º')">
          üìä –¢–æ–ø 3 —Ç–æ–≤–∞—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
        </div>
        <div class="example-query" onclick="useExample('–°—É–º–º–∞ –≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ 500000')">
          ‚ûï –°—É–º–º–∞ –≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ 500000
        </div>
        <div class="example-query" onclick="useExample('–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º')">
          üìà –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        </div>
      </div>
    </div>

    <!-- Messages will be added here dynamically -->
  </div>

  <!-- Input Area -->
  <div class="input-container">
    <div class="input-wrapper">
      <textarea
        id="messageInput"
        placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-—Ç–æ –æ –¥–∞–Ω–Ω—ã—Ö..."
        rows="1"
        onkeydown="handleKeyPress(event)"
      ></textarea>
      <button id="sendBtn" onclick="sendMessage()" disabled>
        ‚û§
      </button>
    </div>
  </div>

  <script>
    let chatHistory = [];
    let isProcessing = false;

    // Initialize
    document.getElementById('messageInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';

      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = !this.value.trim() || isProcessing;
    });

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function useExample(query) {
      document.getElementById('messageInput').value = query;
      document.getElementById('sendBtn').disabled = false;
      sendMessage();
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message || isProcessing) return;

      // Hide empty state
      document.getElementById('emptyState').style.display = 'none';

      // Add user message
      addMessage(message, 'user');

      // Clear input
      input.value = '';
      input.style.height = 'auto';
      document.getElementById('sendBtn').disabled = true;

      // Show loading
      isProcessing = true;
      addLoadingIndicator();

      // Call backend
      google.script.run
        .withSuccessHandler(handleResponse)
        .withFailureHandler(handleError)
        .processQuery(message);
    }

    function addMessage(content, type) {
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = content;

      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);

      scrollToBottom();
    }

    function addAIResponse(result) {
      try {
        const container = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai';

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';

        // Response type badge
        const responseType = result.response_type || 'formula';
        const badge = document.createElement('div');
        badge.className = `response-type-badge response-type-${responseType}`;
        if (responseType === 'analysis') {
          badge.textContent = 'üìä –ê–Ω–∞–ª–∏–∑';
        } else if (responseType === 'action') {
          badge.textContent = 'üéØ –î–µ–π—Å—Ç–≤–∏—è';
          badge.className = 'response-type-badge response-type-formula';
        } else {
          badge.textContent = 'üìù –§–æ—Ä–º—É–ª–∞';
        }
        bubble.appendChild(badge);

        // Main content
        const content = document.createElement('div');

        if (responseType === 'formula' && result.formula) {
          // Formula
          const formulaDiv = document.createElement('div');
          formulaDiv.className = 'formula-code';
          formulaDiv.textContent = result.formula;
          content.appendChild(formulaDiv);

          // Explanation
          const explanation = document.createElement('p');
          explanation.textContent = result.explanation;
          content.appendChild(explanation);

          // Action buttons
          const actions = document.createElement('div');
          actions.className = 'action-buttons';

          const insertBtn = document.createElement('button');
          insertBtn.className = 'action-btn primary';
          insertBtn.textContent = '‚úì –í—Å—Ç–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É';
          insertBtn.onclick = () => insertFormula(result.formula, result.target_cell);
          actions.appendChild(insertBtn);

          const copyBtn = document.createElement('button');
          copyBtn.className = 'action-btn';
          copyBtn.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
          copyBtn.onclick = () => copyToClipboard(result.formula);
          actions.appendChild(copyBtn);

          content.appendChild(actions);
        } else if (responseType === 'action' && result.insights) {
          // Action Plan
          const explanation = document.createElement('p');
          explanation.textContent = result.explanation;
          content.appendChild(explanation);

          // Display actions
          if (result.insights && result.insights.length > 0) {
            const actionsTitle = document.createElement('p');
            actionsTitle.style.marginTop = '12px';
            actionsTitle.style.fontWeight = '500';
            actionsTitle.textContent = 'üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:';
            content.appendChild(actionsTitle);

            const actionsList = document.createElement('ul');
            actionsList.className = 'insights-list';
            result.insights.forEach(action => {
              const li = document.createElement('li');
              if (action.type === 'create_chart') {
                li.textContent = `üìä –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫: ${action.config.title || '–ì—Ä–∞—Ñ–∏–∫ –¥–∞–Ω–Ω—ã—Ö'} (–¥–∏–∞–ø–∞–∑–æ–Ω: ${action.config.dataRange})`;
              } else if (action.type === 'format_cells') {
                li.textContent = `üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —è—á–µ–π–∫–∏: ${action.config.range}`;
              } else if (action.type === 'insert_formula') {
                li.textContent = `üìù –í—Å—Ç–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É: ${action.config.formula}`;
              } else {
                li.textContent = `${action.type}: ${JSON.stringify(action.config)}`;
              }
              actionsList.appendChild(li);
            });
            content.appendChild(actionsList);
          }

          // Execute button
          const actions = document.createElement('div');
          actions.className = 'action-buttons';

          const executeBtn = document.createElement('button');
          executeBtn.className = 'action-btn primary';
          executeBtn.textContent = '‚ñ∂ –í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—è';
          executeBtn.onclick = () => executeActions(result.insights);
          actions.appendChild(executeBtn);

          content.appendChild(actions);
        } else {
          // Analysis - structured response

          // Summary
          if (result.summary) {
            const summaryDiv = document.createElement('div');
            summaryDiv.style.padding = '10px';
            summaryDiv.style.backgroundColor = '#f5f5f5';
            summaryDiv.style.borderRadius = '6px';
            summaryDiv.style.marginBottom = '12px';
            summaryDiv.style.fontWeight = '500';
            summaryDiv.innerHTML = `<strong>üìä –í—ã–≤–æ–¥:</strong><br>${result.summary}`;
            content.appendChild(summaryDiv);
          } else if (result.explanation || result.answer) {
            const answer = document.createElement('p');
            answer.textContent = result.explanation || result.answer;
            content.appendChild(answer);
          }

          // Methodology
          if (result.methodology) {
            const methodologyDiv = document.createElement('div');
            methodologyDiv.style.padding = '10px';
            methodologyDiv.style.backgroundColor = '#e3f2fd';
            methodologyDiv.style.borderRadius = '6px';
            methodologyDiv.style.marginBottom = '12px';
            methodologyDiv.style.fontSize = '13px';
            methodologyDiv.innerHTML = `${result.methodology}`;
            content.appendChild(methodologyDiv);
          }

          // Key findings
          if (result.key_findings && result.key_findings.length > 0) {
            const findingsTitle = document.createElement('p');
            findingsTitle.style.marginTop = '12px';
            findingsTitle.style.fontWeight = '600';
            findingsTitle.style.marginBottom = '6px';
            findingsTitle.textContent = 'üîç –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:';
            content.appendChild(findingsTitle);

            const findingsList = document.createElement('ul');
            findingsList.className = 'insights-list';
            findingsList.style.listStyle = 'none';
            findingsList.style.padding = '0';
            result.key_findings.forEach(finding => {
              const li = document.createElement('li');
              li.style.padding = '6px 0';
              li.style.borderBottom = '1px solid #eee';
              li.textContent = finding;
              findingsList.appendChild(li);
            });
            content.appendChild(findingsList);
          }

          // Insights
          if (result.insights && result.insights.length > 0) {
            const insightsTitle = document.createElement('p');
            insightsTitle.style.marginTop = '12px';
            insightsTitle.style.fontWeight = '600';
            insightsTitle.style.marginBottom = '6px';
            insightsTitle.textContent = 'üí° –ò–Ω—Å–∞–π—Ç—ã:';
            content.appendChild(insightsTitle);

            const insightsList = document.createElement('ul');
            insightsList.className = 'insights-list';
            insightsList.style.listStyle = 'none';
            insightsList.style.padding = '0';
            result.insights.forEach(insight => {
              const li = document.createElement('li');
              li.style.padding = '6px 0';

              if (typeof insight === 'object') {
                if (insight.type === 'create_chart') {
                  li.textContent = `üìä –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫: ${insight.config.title || '–ì—Ä–∞—Ñ–∏–∫ –¥–∞–Ω–Ω—ã—Ö'}`;
                } else {
                  li.textContent = `${insight.type}: ${JSON.stringify(insight.config || insight)}`;
                }
              } else {
                li.textContent = insight;
              }
              insightsList.appendChild(li);
            });
            content.appendChild(insightsList);
          }

          // Suggested actions
          if (result.suggested_actions && result.suggested_actions.length > 0) {
            const actionsTitle = document.createElement('p');
            actionsTitle.style.marginTop = '12px';
            actionsTitle.style.fontWeight = '600';
            actionsTitle.style.marginBottom = '6px';
            actionsTitle.textContent = '‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:';
            content.appendChild(actionsTitle);

            const actionsList = document.createElement('ul');
            actionsList.className = 'insights-list';
            actionsList.style.listStyle = 'none';
            actionsList.style.padding = '0';
            actionsList.style.backgroundColor = '#e8f5e9';
            actionsList.style.padding = '8px';
            actionsList.style.borderRadius = '6px';
            result.suggested_actions.forEach(action => {
              const li = document.createElement('li');
              li.style.padding = '4px 0';
              li.textContent = action;
              actionsList.appendChild(li);
            });
            content.appendChild(actionsList);
          }

          // –í—Å–µ —É–±—Ä–∞–Ω–æ - —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–æ–≤!
        }

        bubble.appendChild(content);
        messageDiv.appendChild(bubble);
        container.appendChild(messageDiv);

        scrollToBottom();
      } catch (error) {
        console.error('Error in addAIResponse:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        const container = document.getElementById('chatContainer');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message ai';
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.style.borderColor = '#f44336';
        bubble.innerHTML = `<p style="color: #f44336;">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: ${error.message}</p>`;
        errorDiv.appendChild(bubble);
        container.appendChild(errorDiv);
      }
    }

    function addLoadingIndicator() {
      const container = document.getElementById('chatContainer');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message ai';
      loadingDiv.id = 'loading';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      const loading = document.createElement('div');
      loading.className = 'loading-indicator';
      loading.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';

      bubble.appendChild(loading);
      loadingDiv.appendChild(bubble);
      container.appendChild(loadingDiv);

      scrollToBottom();
    }

    function removeLoadingIndicator() {
      const loading = document.getElementById('loading');
      if (loading) loading.remove();
    }

    function handleResponse(result) {
      removeLoadingIndicator();
      isProcessing = false;

      if (result) {
        addAIResponse(result);
      } else {
        handleError({message: '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞'});
      }
    }

    function handleError(error) {
      removeLoadingIndicator();
      isProcessing = false;

      const container = document.getElementById('chatContainer');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'message ai';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.style.borderColor = '#f44336';
      bubble.innerHTML = `<p style="color: #f44336;">‚ùå –û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>`;

      errorDiv.appendChild(bubble);
      container.appendChild(errorDiv);

      scrollToBottom();
    }

    function scrollToBottom() {
      const container = document.getElementById('chatContainer');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function insertFormula(formula, targetCell) {
      google.script.run
        .withSuccessHandler(() => {
          alert('‚úì –§–æ—Ä–º—É–ª–∞ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞!');
        })
        .withFailureHandler((error) => {
          alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        })
        .insertFormula(formula, targetCell);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
      }).catch(() => {
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      });
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü/–≥—Ä–∞—Ñ–∏–∫–æ–≤ —É–¥–∞–ª–µ–Ω—ã - —Ñ–æ–∫—É—Å –Ω–∞ —Ä–∞—Å—á–µ—Ç–∞—Ö!
  </script>
</body>
</html>
