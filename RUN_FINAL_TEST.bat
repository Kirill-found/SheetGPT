@echo off
chcp 65001 > nul
cls

echo ╔════════════════════════════════════════════════════════════╗
echo ║          🔥 ФИНАЛЬНЫЙ ТЕСТ ИСПРАВЛЕНИЯ SHEETGPT 🔥        ║
echo ╠════════════════════════════════════════════════════════════╣
echo ║                                                            ║
echo ║  Этот тест проверит что проблема с агрегацией исправлена  ║
echo ║                                                            ║
echo ║  ПРАВИЛЬНЫЙ ОТВЕТ: ООО Время: 442,702.04                  ║
echo ║  НЕПРАВИЛЬНЫЙ: ООО Радость: 378,191.85                    ║
echo ║                                                            ║
echo ╚════════════════════════════════════════════════════════════╝
echo.
echo Нажми любую клавишу чтобы начать тест...
pause > nul

echo.
echo ════════════════════════════════════════════════════════════
echo 📡 ШАГ 1: Проверяю версию API...
echo ════════════════════════════════════════════════════════════
curl -s https://sheetgpt-production.up.railway.app/ | python -c "import sys, json; d=json.load(sys.stdin); print(f'Версия: {d.get(\"version\", \"ERROR\")}'); print('✅ OK' if d.get('version')=='3.0.0' else '❌ НУЖНО ОБНОВИТЬ до 3.0.0')"
echo.

echo ════════════════════════════════════════════════════════════
echo 📊 ШАГ 2: Тестирую агрегацию с автоматическими колонками...
echo ════════════════════════════════════════════════════════════
echo.

set JSON_FILE=test_final_aggregation.json
(
echo {
echo   "query": "у какого поставщика больше всего продаж",
echo   "column_names": ["Колонка A", "Колонка B", "Колонка C", "Колонка D", "Колонка E"],
echo   "sheet_data": [
echo     ["Товар 1", "ООО Время", 10730.32, 1010, 107303.2],
echo     ["Товар 2", "ООО Сатурн", 8568.37, 1030, 257051.1],
echo     ["Товар 3", "ООО Луна", 7318.09, 1020, 146361.8],
echo     ["Товар 14", "ООО Время", 6328.28, 1007, 44297.96],
echo     ["Товар 5", "ООО Персектив", 1196.9, 1017, 20347.3],
echo     ["Товар 14", "ООО Время", 6328.28, 1023, 145550.44],
echo     ["Товар 7", "ООО Космос", 2499.28, 1012, 29991.36],
echo     ["Товар 8", "ООО Радость", 25212.79, 1015, 378191.85],
echo     ["Товар 14", "ООО Время", 6328.28, 1023, 145550.44],
echo     ["Товар 10", "ИП Разум", 17789.22, 1010, 177892.2]
echo   ],
echo   "history": []
echo }
) > %JSON_FILE%

echo Отправляю запрос...
echo.

curl -s -X POST "https://sheetgpt-production.up.railway.app/api/v1/formula" ^
  -H "Content-Type: application/json" ^
  -d @%JSON_FILE% > response.json

echo РЕЗУЛЬТАТ:
echo ──────────────────────────────────────────────────────────
type response.json | python -c "import sys, json; d=json.load(sys.stdin); print(f'Summary: {d.get(\"summary\", \"НЕТ\")}'); print(f'\nMethodology:\n{d.get(\"methodology\", \"НЕТ\")}'); findings=d.get(\"key_findings\", []); print(f'\nKey Findings:'); [print(f'  • {f}') for f in findings]"
echo ──────────────────────────────────────────────────────────
echo.

REM Проверяем результат
type response.json | python -c "import sys, json; d=json.load(sys.stdin); s=d.get('summary','').lower(); print(''); print('='*60); print('✅✅✅ УСПЕХ! Проблема исправлена!' if 'время' in s and '442' in s else '❌❌❌ ОШИБКА! Всё ещё возвращает Радость!' if 'радость' in s else '⚠️ Неопределённый результат'); print('='*60)"

echo.
echo ════════════════════════════════════════════════════════════
echo 🔍 ШАГ 3: Полный Python-тест...
echo ════════════════════════════════════════════════════════════
echo.

if exist VERIFY_FIX.py (
    python VERIFY_FIX.py
) else (
    echo ❌ Файл VERIFY_FIX.py не найден
)

REM Удаляем временные файлы
del %JSON_FILE% 2>nul
del response.json 2>nul

echo.
echo ╔════════════════════════════════════════════════════════════╗
echo ║                    ТЕСТ ЗАВЕРШЁН                          ║
echo ╠════════════════════════════════════════════════════════════╣
echo ║                                                            ║
echo ║  Если всё ещё показывает "Радость", выполни:              ║
echo ║                                                            ║
echo ║  1. Открой DEPLOY_FINAL.md                                ║
echo ║  2. Выполни ВСЕ шаги по порядку                          ║
echo ║  3. Особенно важен шаг с очисткой кеша                   ║
echo ║                                                            ║
echo ╚════════════════════════════════════════════════════════════╝
echo.
pause