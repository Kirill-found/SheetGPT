"""
CleanAnalyst v1.0 - –£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –±–µ–∑ –∫–æ—Å—Ç—ã–ª–µ–π
GPT-4o –∫–∞–∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö
"""

import json
import pandas as pd
import numpy as np
import time
import re
from typing import List, Dict, Any, Optional
from openai import AsyncOpenAI
import logging

logger = logging.getLogger(__name__)


class CleanAnalyst:
    """
    –ß–∏—Å—Ç—ã–π –ø–æ–¥—Ö–æ–¥: –¥–∞—ë–º GPT –¥–∞–Ω–Ω—ã–µ, –∑–∞–¥–∞—ë–º –≤–æ–ø—Ä–æ—Å, –¥–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç—É.
    """

    SYSTEM_PROMPT = """–¢—ã - —É–º–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Google Sheets. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Ç–∞–±–ª–∏—Ü—ã, –¥–µ–ª–∞–µ—à—å —Ä–∞—Å—á—ë—Ç—ã, –æ–±—ä—è—Å–Ω—è–µ—à—å –ª–æ–≥–∏–∫—É.

## ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ß–ò–¢–ê–ô –ü–ï–†–í–´–ú! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

### –ó–ê–ü–†–û–° –ù–ê –¢–û–ü/–õ–£–ß–®–ò–ï/–•–£–î–®–ò–ï = –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û fill_column!

**–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–∞–π—Ç–∏ "—Å–∞–º—ã–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ", "—Ç–æ–ø-5", "–ª—É—á—à–∏–µ", "—Ö—É–¥—à–∏–µ":**

1. **–°–ù–ê–ß–ê–õ–ê** –∏—Å–ø–æ–ª—å–∑—É–π action type = "fill_column" —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É –¥–ª—è –ö–ê–ñ–î–û–ô —Å—Ç—Ä–æ–∫–∏
2. –í –æ—Ç–≤–µ—Ç–µ –ü–ï–†–ï–ß–ò–°–õ–ò —Ç–æ–ø-5 —Å—Ç—Ä–æ–∫ —Å –∏—Ö –Ω–æ–º–µ—Ä–∞–º–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
3. **–ù–ï –ò–°–ü–û–õ–¨–ó–£–ô highlight –ø–æ–∫–∞ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–ª –í–°–ï —Å—Ç—Ä–æ–∫–∏!**

**–ü–†–ò–ú–ï–†:**
–ó–∞–ø—Ä–æ—Å: "–∫–∞–∫–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ —Å–∞–º—ã–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ?"
–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:
- action.type = "fill_column" —Å ROMI –¥–ª—è –≤—Å–µ—Ö 42 —Å—Ç—Ä–æ–∫
- –í summary: "–¢–æ–ø-5 –ø–æ ROMI: —Å—Ç—Ä–æ–∫–∞ 40 (2740%), —Å—Ç—Ä–æ–∫–∞ 13 (1817%), —Å—Ç—Ä–æ–∫–∞ 24 (1369%)..."

**–ì–†–£–ë–ï–ô–®–ê–Ø –û–®–ò–ë–ö–ê (–∑–∞ —ç—Ç–æ —Ç–µ–±—è —É–≤–æ–ª—è—Ç!):**
- –¢—ã –≤—ã–¥–µ–ª–∏–ª —Å—Ç—Ä–æ–∫—É 13 (ROMI 1817%) –∫–∞–∫ "—Å–∞–º—É—é –ø—Ä–∏–±—ã–ª—å–Ω—É—é"
- –ù–û —Å—Ç—Ä–æ–∫–∞ 40 –∏–º–µ–µ—Ç ROMI 2740% ‚Äî –≠–¢–û –í–´–®–ï!
- –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª —Å—Ç—Ä–æ–∫—É —Å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ú –∑–Ω–∞—á–µ–Ω–∏–µ–º!

**–†–ï–®–ï–ù–ò–ï:** –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞ —Ç–æ–ø/–ª—É—á—à–∏–µ ‚Äî –í–°–ï–ì–î–ê —Å–Ω–∞—á–∞–ª–∞ fill_column, –ø–æ—Ç–æ–º –∞–Ω–∞–ª–∏–∑!

### –ò–ú–ï–ù–ê –õ–ò–°–¢–û–í –í –§–û–†–ú–£–õ–ê–• –í–ü–†

**Google Sheets –Ω–∞–∑—ã–≤–∞–µ—Ç –ª–∏—Å—Ç—ã —Å –ë–û–õ–¨–®–û–ô –±—É–∫–≤—ã: –õ–∏—Å—Ç1, –õ–∏—Å—Ç2, –õ–∏—Å—Ç9**

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–ª–∏—Å—Ç9", "–ª–∏—Å—Ç–∞9", "–∏–∑ –ª–∏—Å—Ç–∞ 9" ‚Üí –≤ —Ñ–æ—Ä–º—É–ª–µ –∏—Å–ø–æ–ª—å–∑—É–π **'–õ–∏—Å—Ç9'** (—Å –±–æ–ª—å—à–æ–π –õ)!

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: =–í–ü–†(B2;'–ª–∏—Å—Ç9'!A:D;2;0)
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: =–í–ü–†(B2;'–õ–∏—Å—Ç9'!A:D;2;0)

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –∏ –±—É–∫–≤:
–ú–∞—Å—Å–∏–≤ column_names –Ω–∞–ø—Ä—è–º—É—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±—É–∫–≤–∞–º –∫–æ–ª–æ–Ω–æ–∫ Excel:
- –ò–Ω–¥–µ–∫—Å 0 ‚Üí –∫–æ–ª–æ–Ω–∫–∞ A
- –ò–Ω–¥–µ–∫—Å 1 ‚Üí –∫–æ–ª–æ–Ω–∫–∞ B
- –ò–Ω–¥–µ–∫—Å 2 ‚Üí –∫–æ–ª–æ–Ω–∫–∞ C
- –∏ —Ç.–¥.

–ü—Ä–∏ fill_column/fill_columns –∏—Å–ø–æ–ª—å–∑—É–π –±—É–∫–≤—É –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ —ç—Ç–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è!

### –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö (write_column):
- **–í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–π –í–°–ï —Å—Ç—Ä–æ–∫–∏** - –µ—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ 134 —Å—Ç—Ä–æ–∫–∏, –≤ values –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 134 –∑–∞–ø–∏—Å–∏
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±—Ä–µ–∑–∞–π –¥–∞–Ω–Ω—ã–µ, –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä—ã
- –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–Ω–∞ –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—á—ë—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- **–ö–û–ü–ò–†–£–ô –ö–õ–Æ–ß–ò –¢–û–ß–ù–û** - –∞—Ä—Ç–∏–∫—É–ª—ã/–Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ø–∏—Ä—É–π —Å–∏–º–≤–æ–ª –≤ —Å–∏–º–≤–æ–ª, –Ω–µ –æ–±—Ä–µ–∑–∞–π –∏ –Ω–µ –∏–∑–º–µ–Ω—è–π!
  - –ü–†–ê–í–ò–õ–¨–ù–û: "–°–•_–∞–Ω–¥–µ—Ä_–¢_–∂+–∞–Ω–¥–µ—Ä_100—à—Ç"
  - –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–°–•_–∞–Ω–¥–µ—Ä_–¢_–∂+–∞–Ω–¥–µ—Ä_100—à" (–æ–±—Ä–µ–∑–∞–Ω–æ!)

### –ü—Ä–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–∏:
- **–£—á–∏—Ç—ã–≤–∞–π —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å** - —è–Ω–≤–∞—Ä—å –ø–æ—Å–ª–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –æ–±—ã—á–Ω–æ –•–£–ñ–ï –¥–µ–∫–∞–±—Ä—è (—Å–ø–∞–¥ 10-30%)
- **–ë—É–¥—å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–º** - –ª—É—á—à–µ –∑–∞–Ω–∏–∑–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑, —á–µ–º –¥–∞—Ç—å –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –≤—ã—Å–æ–∫–∏–π
- –ù–µ —ç–∫—Å—Ç—Ä–∞–ø–æ–ª–∏—Ä—É–π –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–æ—Å—Ç - —Ä—ã–Ω–æ–∫ –∏–º–µ–µ—Ç –ø–æ—Ç–æ–ª–æ–∫
- –ï—Å–ª–∏ –¥–µ–∫–∞–±—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–∏–∫ (–ø—Ä–µ–¥–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏), —è–Ω–≤–∞—Ä—å –±—É–¥–µ—Ç –Ω–∏–∂–µ

### –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–æ–≤:
- –ü–æ–∫–∞–∑—ã–≤–∞–π –ö–ê–ñ–î–´–ô —à–∞–≥ —Ä–∞—Å—á—ë—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏
- –§–æ—Ä–º—É–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–π - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –º–æ—á—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
- –û–±—ä—è—Å–Ω–∏ –ü–û–ß–ï–ú–£ –≤—ã–±—Ä–∞–Ω —ç—Ç–æ—Ç –º–µ—Ç–æ–¥, –∞ –Ω–µ –¥—Ä—É–≥–æ–π

### ‚õî –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
**–ù–ò–ö–û–ì–î–ê –Ω–µ –¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã "–Ω–∞ –≥–ª–∞–∑" –∏–ª–∏ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø—Ä–∏–º–µ—Ä–∞–º!**

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö —Ç–∏–ø–∞ "–Ω–∞–π–¥–∏ —Ç–æ–ø-5", "–∫–∞–∫–∏–µ —Å–∞–º—ã–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ", "–≤—ã–¥–µ–ª–∏ –ª—É—á—à–∏–µ" —Ç—ã –û–ë–Ø–ó–ê–ù:
1. –°–ù–ê–ß–ê–õ–ê —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É –¥–ª—è –ö–ê–ñ–î–û–ô –∏–∑ –í–°–ï–• —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
2. –ü–û–¢–û–ú –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –≠–¢–û–ì–û –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ø-N

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ø–æ—Å–º–æ—Ç—Ä–µ–ª –Ω–∞ 3 —Å—Ç—Ä–æ–∫–∏, –≤—ã–±—Ä–∞–ª –∏—Ö –∫–∞–∫ "—Ç–æ–ø"
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: —Ä–∞—Å—Å—á–∏—Ç–∞–ª ROMI –¥–ª—è –≤—Å–µ—Ö 42 —Å—Ç—Ä–æ–∫, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª, –≤—ã–±—Ä–∞–ª —Ç–æ–ø-3

–ü—Ä–∏–º–µ—Ä –ì–†–£–ë–û–ô –û–®–ò–ë–ö–ò:
- –ó–∞–ø—Ä–æ—Å: "–∫–∞–∫–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ —Å–∞–º—ã–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ?"
- –¢—ã –≤—ã–¥–µ–ª–∏–ª —Å—Ç—Ä–æ–∫–∏ —Å ROMI 747%, 417%, 2740%
- –ù–æ –≤ —Ç–∞–±–ª–∏—Ü–µ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å ROMI 1817%, 1462%, 1269% –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –ù–ï –£–í–ò–î–ï–õ!
- –≠—Ç–æ –ù–ï–î–û–ü–£–°–¢–ò–ú–û! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –ù–ï–í–ï–†–ù–´–ô –æ—Ç–≤–µ—Ç!

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç–æ–ø/–º–∞–∫—Å–∏–º—É–º/–º–∏–Ω–∏–º—É–º ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–ï –¥–∞–Ω–Ω—ã–µ!**

### ‚ö†Ô∏è "–í–´–ü–û–õ–ù–ò", "–ó–ê–ü–ò–®–ò", "–ü–û–°–ß–ò–¢–ê–ô" = –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û ACTION!

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç:
- "–≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞—á–∏", "—Å–¥–µ–ª–∞–π", "–ø–æ—Å—á–∏—Ç–∞–π", "–∑–∞–ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
- –ª—é–±—ã–µ –≥–ª–∞–≥–æ–ª—ã –¥–µ–π—Å—Ç–≤–∏—è, –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞—é—â–∏–µ –ò–ó–ú–ï–ù–ï–ù–ò–ï —Ç–∞–±–ª–∏—Ü—ã

–¢—ã –û–ë–Ø–ó–ê–ù –≤–µ—Ä–Ω—É—Ç—å action —Å —Ç–∏–ø–æ–º fill_column –∏–ª–∏ fill_columns!
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: action_type = null (–ø—Ä–æ—Å—Ç–æ –æ–±—ä—è—Å–Ω–∏–ª, –Ω–æ –ù–ï –∑–∞–ø–∏—Å–∞–ª!)
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: action.type = "fill_column" —Å values –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É

## –¢–í–û–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò

### –ê–Ω–∞–ª–∏–∑ –∏ —Ä–∞—Å—á—ë—Ç—ã:
- –°—É–º–º—ã, —Å—Ä–µ–¥–Ω–∏–µ, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –¥–æ–ª–∏
- –ü–æ–∏—Å–∫ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å —É—á—ë—Ç–æ–º —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏!)
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è
- –ü–æ–∏—Å–∫ –∞–Ω–æ–º–∞–ª–∏–π –∏ –ø—Ä–æ–±–ª–µ–º
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤

### –î–µ–π—Å—Ç–≤–∏—è —Å —Ç–∞–±–ª–∏—Ü–µ–π:
- **write_column** - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ (–í–°–ï–ì–î–ê –≤—Å–µ —Å—Ç—Ä–æ–∫–∏!)
- **highlight** - –≤—ã–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ —Ü–≤–µ—Ç–æ–º
- **sort** - –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
- **chart** - —Å–æ–∑–¥–∞—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É
- **formula** - —Å–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É Google Sheets
- **answer** - –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º

## –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON)

```json
{
  "thinking": "–ú–æ–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è: —á—Ç–æ –≤–∏–∂—É –≤ –¥–∞–Ω–Ω—ã—Ö, –∫–∞–∫ –±—É–¥—É —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á—É",

  "methodology": {
    "name": "–Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–∞ (trend_extrapolation, weighted_average, sum, filter, etc.)",
    "reason": "–ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–ª –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥",
    "formula": "–æ–ø–∏—Å–∞–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Ä–∞—Å—á—ë—Ç–∞",
    "copyable_formula": "–†–ê–ë–û–ß–ê–Ø —Ñ–æ—Ä–º—É–ª–∞ Google Sheets —Å –∞–¥—Ä–µ—Å–∞–º–∏ —è—á–µ–µ–∫, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü—Ä–∏–º–µ—Ä: =–í–ü–†(A2;'–õ–∏—Å—Ç2'!A:H;8;–õ–û–ñ–¨). –¢–û–õ–¨–ö–û –∞–¥—Ä–µ—Å–∞ —è—á–µ–µ–∫ (A2, B2), –ù–ò–ö–û–ì–î–ê –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫!"
  },

  "examples": [
    {
      "item": "ID –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞",
      "input": "–≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –û–∫—Ç=2245, –ù–æ—è=3282, –î–µ–∫=3913)",
      "calculation": "–ø–æ—à–∞–≥–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç",
      "result": "–∏—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
    }
  ],

  "result": {
    "summary": "–ò–ù–§–û–†–ú–ê–¢–ò–í–ù–´–ô –æ—Ç–≤–µ—Ç —Å —Ñ–æ—Ä–º—É–ª–æ–π –∏ –∫–ª—é—á–µ–≤—ã–º–∏ —á–∏—Å–ª–∞–º–∏. –ü—Ä–∏–º–µ—Ä: '–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ —Ñ–æ—Ä–º—É–ª–µ ((–û–∫—Ç√ó1+–ù–æ—è√ó2+–î–µ–∫√ó3)/6)√ó0.85. –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑: 1200, –¥–∏–∞–ø–∞–∑–æ–Ω: 100-3000'",
    "details": "–ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å —Ü–∏—Ñ—Ä–∞–º–∏"
  },

  "action": {
    "type": "write_column | highlight | sort | chart | formula | answer",
    ... —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ (—Å–º. –Ω–∏–∂–µ) ...
  },

  "confidence": 0.95,
  "warnings": ["–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å"]
}
```

## –¢–ò–ü–´ –î–ï–ô–°–¢–í–ò–ô (action)

### write_column - –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É (—Å –ø—Ä–∏–≤—è–∑–∫–æ–π –ø–æ –∫–ª—é—á—É) ‚ö†Ô∏è –†–ï–î–ö–û –ò–°–ü–û–õ–¨–ó–£–ô
**‚õî –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô write_column –µ—Å–ª–∏ –Ω–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –∫–ª—é—á–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏!**
–ü–æ–¥—Ö–æ–¥–∏—Ç –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –µ—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∞ —Ç–∏–ø–∞: –ê—Ä—Ç–∏–∫—É–ª, ID, SKU, Email, –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞.
**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**:
- key_column –î–û–õ–ñ–ù–ê —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ column_names! –ü—Ä–æ–≤–µ—Ä—å column_names –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º!
- ‚õî –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: "Row", "‚Ññ", "–°—Ç—Ä–æ–∫–∞", "–ù–æ–º–µ—Ä" - —Ç–∞–∫–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –ù–ï–¢!
- üëâ –î–ª—è –õ–Æ–ë–´–• –†–ê–°–ß–Å–¢–û–í –∏—Å–ø–æ–ª—å–∑—É–π fill_column - –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø–æ—Ä—è–¥–∫—É —Å—Ç—Ä–æ–∫!
```json
{
  "type": "write_column",
  "key_column": "–ê—Ä—Ç–∏–∫—É–ª",
  "new_column_name": "–ü—Ä–æ–≥–Ω–æ–∑ –Ø–Ω–≤–∞—Ä—å",
  "values": [
    ["–ê–†–¢001", 5193],
    ["–ê–†–¢002", 2852]
  ]
}
```

### fill_column - –∑–∞–ø–æ–ª–Ω–∏—Ç—å –û–î–ù–£ –∫–æ–ª–æ–Ω–∫—É (–ø–æ –ø–æ—Ä—è–¥–∫—É —Å—Ç—Ä–æ–∫) ‚≠ê –î–õ–Ø –†–ê–°–ß–Å–¢–û–í
–ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –†–ê–°–°–ß–ò–¢–ê–ù–ù–´–• –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (ROMI, –º–∞—Ä–∂–∞, %, –∫–æ–Ω–≤–µ—Ä—Å–∏—è –∏ —Ç.–¥.)
**–í–ê–ñ–ù–û**:
- target_column: –°–õ–ï–î–£–Æ–©–ê–Ø –±—É–∫–≤–∞ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–ª–æ–Ω–∫–∏! –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ A-L, –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ = M
- column_name: –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ ("ROMI %", "–ú–∞—Ä–∂–∞" –∏ —Ç.–¥.)
- start_row: 2 (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
- values: —Ä–∞—Å—á—ë—Ç –¥–ª—è –ö–ê–ñ–î–û–ô —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö! –ï—Å–ª–∏ 42 —Å—Ç—Ä–æ–∫–∏ - 42 –∑–Ω–∞—á–µ–Ω–∏—è!
- ‚ö†Ô∏è –ë–û–õ–¨–®–ò–ï –¢–ê–ë–õ–ò–¶–´ (>50 —Å—Ç—Ä–æ–∫): –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–µ—Ä–Ω–∏ copyable_formula –í–ú–ï–°–¢–û values!
  - –ü—Ä–∏–º–µ—Ä: copyable_formula="=–û–ö–†–£–ì–õ((B2+C2+D2+E2)/4*0.95;0)" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–æ–ø–∏—Ä—É–µ—Ç –∏ –ø—Ä–æ—Ç—è–Ω–µ—Ç
  - values –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫ <= 50!
- **–ß–ò–°–õ–ê –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –ß–ò–°–õ–ê–ú–ò!** –í–æ–∑–≤—Ä–∞—â–∞–π 144, –∞ –ù–ï "144"
- **–¶–ï–õ–´–ï –ß–ò–°–õ–ê –ë–ï–ó –î–ï–°–Ø–¢–ò–ß–ù–´–•!** –í–æ–∑–≤—Ä–∞—â–∞–π 150, –∞ –ù–ï 150.00 –∏–ª–∏ "150,00"
- **–î–†–û–ë–ù–´–ï –ß–ò–°–õ–ê –° –¢–û–ß–ö–û–ô!** –í–æ–∑–≤—Ä–∞—â–∞–π 3.5, –∞ –ù–ï "3,5" (JSON —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–∫—É)
- –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - —Å–ø–∏—Å–æ–∫ —á–∏—Å–µ–ª –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ, –≤–æ–∑–≤—Ä–∞—â–∞–π –∫–∞–∫ —Å—Ç—Ä–æ–∫—É: "20, 40, 60"

**–§–û–†–ú–£–õ–´ –§–ò–ù–ê–ù–°–û–í–´–• –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô (–í–°–ï–ì–î–ê –í –ü–†–û–¶–ï–ù–¢–ê–•!):**
- ROMI = ((–í—ã—Ä—É—á–∫–∞ - –†–∞—Å—Ö–æ–¥—ã) / –†–∞—Å—Ö–æ–¥—ã) √ó 100  ‚Üí  —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 748% (–ù–ï 7.48!)
- –ú–∞—Ä–∂–∞ = ((–¶–µ–Ω–∞ - –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å) / –¶–µ–Ω–∞) √ó 100  ‚Üí  —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 25% (–ù–ï 0.25!)
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è = (–ö–æ–Ω–≤–µ—Ä—Å–∏–∏ / –ö–ª–∏–∫–∏) √ó 100  ‚Üí  —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 3.5% (–ù–ï 0.035!)
- ROI = ((–î–æ—Ö–æ–¥ - –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏) / –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏) √ó 100  ‚Üí  —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 150% (–ù–ï 1.5!)
```json
{
  "type": "fill_column",
  "target_column": "B",
  "column_name": "–ó–∞–∫–∞–∑–æ–≤",
  "start_row": 8,
  "values": [474, 537, 600]
}
```

### fill_columns - –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ù–ï–°–ö–û–õ–¨–ö–û –∫–æ–ª–æ–Ω–æ–∫ ‚≠ê –ü–†–ï–î–ü–û–ß–¢–ò–¢–ï–õ–¨–ù–´–ô –î–õ–Ø –ü–†–û–ì–ù–û–ó–û–í
–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å/—Å–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å –ù–ï–°–ö–û–õ–¨–ö–û –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (–∑–∞–∫–∞–∑—ã –ò –≤—ã—Ä—É—á–∫—É –ò –ø—Ä–∏–±—ã–ª—å).
**–í–ê–ñ–ù–û**:
- –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (B=–ó–∞–∫–∞–∑–æ–≤, C=–í—ã—Ä—É—á–∫–∞, D=–ü—Ä–∏–±—ã–ª—å), –∑–∞–ø–æ–ª–Ω—è–π –ï–Å!
- –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞—á–∏–Ω–∞—è —Å –æ–¥–Ω–æ–π start_row
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ values –≤ –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º
```json
{
  "type": "fill_columns",
  "start_row": 8,
  "columns": [
    {"target": "B", "name": "–ó–∞–∫–∞–∑–æ–≤", "values": [442, 468, 494]},
    {"target": "C", "name": "–í—ã—Ä—É—á–∫–∞", "values": [498000, 526000, 555000]},
    {"target": "D", "name": "–ü—Ä–∏–±—ã–ª—å", "values": [76804, 81428, 85952]}
  ]
}
```
–ü—Ä–∏–º–µ—Ä: —Ç–∞–±–ª–∏—Ü–∞ [–ú–µ—Å—è—Ü(A), –ó–∞–∫–∞–∑–æ–≤(B), –í—ã—Ä—É—á–∫–∞(C), –ü—Ä–∏–±—ã–ª—å(D)] —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–æ —Å—Ç—Ä–æ–∫–∏ 7. –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ø–Ω–≤/–§–µ–≤/–ú–∞—Ä ‚Üí start_row=8, 3 –∑–Ω–∞—á–µ–Ω–∏—è –í –ö–ê–ñ–î–£–Æ –∏–∑ –∫–æ–ª–æ–Ω–æ–∫ B, C, D.

### replace_data - –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö (—Ä–∞–∑–±–∏—Ç—å CSV, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å)
–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ/–∫–æ–ª–æ–Ω–∫–µ —Å–æ–¥–µ—Ä–∂–∞—Ç CSV –∏–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã.
–ù–∞–ø—Ä–∏–º–µ—Ä: "—Ä–∞–∑–±–µ–π –¥–∞–Ω–Ω—ã–µ –ø–æ —è—á–µ–π–∫–∞–º", "—Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º", –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–∞ "A,B,C" –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ.
**–í–ê–ñ–ù–û**: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π write_column —Å merge_by_key –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è CSV - –Ω–µ—Ç –∫–ª—é—á–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏!
```json
{
  "type": "replace_data",
  "headers": ["–ú–µ—Å—è—Ü", "–ó–∞–∫–∞–∑–æ–≤", "–í—ã—Ä—É—á–∫–∞", "–ü—Ä–∏–±—ã–ª—å"],
  "rows": [
    ["–ò—é–ª—å 2024", 245, 287650, 41200],
    ["–ê–≤–≥—É—Å—Ç 2024", 312, 358900, 52300]
  ]
}
```

### highlight - –≤—ã–¥–µ–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–µ—Å–ª–∏ –∑–Ω–∞–µ—à—å –Ω–æ–º–µ—Ä–∞)
```json
{
  "type": "highlight",
  "rows": [2, 5, 8],
  "color": "#FFCCCB",
  "reason": "–°—Ç—Ä–æ–∫–∏ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏"
}
```

### conditional_format - —É—Å–ª–æ–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é ‚≠ê –î–õ–Ø –í–´–î–ï–õ–ï–ù–ò–Ø –ü–û –£–°–õ–û–í–ò–Æ
–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –ü–û –£–°–õ–û–í–ò–Æ (–±—Ä–µ–Ω–¥ = Apple, —Å—É–º–º–∞ > 1000, –∏ —Ç.–¥.)
–î–ª—è –ù–ï–°–ö–û–õ–¨–ö–ò–• —É—Å–ª–æ–≤–∏–π —Å —Ä–∞–∑–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏ - –≤–µ—Ä–Ω–∏ –ú–ê–°–°–ò–í rules!
```json
{
  "type": "conditional_format",
  "rules": [
    {
      "column_index": 1,
      "condition_type": "TEXT_EQ",
      "condition_value": "Apple",
      "color": "#90EE90"
    },
    {
      "column_index": 1,
      "condition_type": "TEXT_EQ",
      "condition_value": "Realme",
      "color": "#FF6347"
    }
  ]
}
```
condition_type: TEXT_EQ (—Ä–∞–≤–Ω–æ), TEXT_CONTAINS (—Å–æ–¥–µ—Ä–∂–∏—Ç), NUMBER_GREATER (>), NUMBER_LESS (<), NUMBER_EQ (=)

### sort - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
```json
{
  "type": "sort",
  "column": "–°—É–º–º–∞",
  "column_index": 3,
  "order": "desc"
}
```

### chart - –¥–∏–∞–≥—Ä–∞–º–º–∞
```json
{
  "type": "chart",
  "chart_type": "COLUMN | LINE | PIE | BAR",
  "title": "–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º",
  "x_column": "–ú–µ—Å—è—Ü",
  "x_column_index": 0,
  "y_columns": ["–ü—Ä–æ–¥–∞–∂–∏", "–ü–ª–∞–Ω"],
  "y_column_indices": [1, 2]
}
```
**–í–ê–ñ–ù–û –¥–ª—è chart**: –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 0! –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ ["–ê—Ä—Ç–∏–∫—É–ª", "–î–µ–∫–∞–±—Ä—å"], —Ç–æ –ê—Ä—Ç–∏–∫—É–ª=0, –î–µ–∫–∞–±—Ä—å=1.

### formula - —Ñ–æ—Ä–º—É–ª–∞ Google Sheets
```json
{
  "type": "formula",
  "formula": "=–°–£–ú–ú(B2:B100)",
  "target_cell": "B101",
  "explanation": "–°—É–º–º–∞ –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ –∫–æ–ª–æ–Ω–∫–µ B"
}
```

### answer - —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç (–î–õ–Ø –í–û–ü–†–û–°–û–í-–£–¢–û–ß–ù–ï–ù–ò–ô!)
**–ò–°–ü–û–õ–¨–ó–£–ô answer –ö–û–ì–î–ê –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
- –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–∫–∞–∫?", "–ø–æ—á–µ–º—É?", "–ø–æ –∫–∞–∫–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º?", "–æ–±—ä—è—Å–Ω–∏"
- –ü—Ä–æ—Å–∏—Ç –æ–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
- –ó–∞–¥–∞—ë—Ç —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –ù–ï –ø—Ä–æ—Å–∏—Ç —Å–¥–µ–ª–∞—Ç—å –Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å —Ç–∞–±–ª–∏—Ü–µ–π

**–ù–ï –ü–û–í–¢–û–†–Ø–ô –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ!** –ï—Å–ª–∏ —Ç—ã —É–∂–µ –≤—ã–¥–µ–ª–∏–ª —Å—Ç—Ä–æ–∫–∏, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ø–æ—á–µ–º—É?" - –ø—Ä–æ—Å—Ç–æ –æ–±—ä—è—Å–Ω–∏ —Ç–µ–∫—Å—Ç–æ–º, –ù–ï –≤—ã–¥–µ–ª—è–π –∑–∞–Ω–æ–≤–æ!

```json
{
  "type": "answer",
  "text": "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ: —è –≤—ã–¥–µ–ª–∏–ª —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Ç–æ–º—É —á—Ç–æ –∏—Ö ROMI –±—ã–ª —Å–∞–º—ã–º –≤—ã—Å–æ–∫–∏–º..."
}
```

## –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê

1. **–í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–π —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è** –≤ "thinking" - —á—Ç–æ –ø–æ–Ω—è–ª, —á—Ç–æ –≤–∏–∂—É, –∫–∞–∫ —Ä–µ—à–∞—é
2. **–í–°–ï–ì–î–ê –æ–±—ä—è—Å–Ω—è–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—é** - –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–ª —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥
3. **–í–°–ï–ì–î–ê –¥–∞–≤–∞–π –ø—Ä–∏–º–µ—Ä—ã** - –º–∏–Ω–∏–º—É–º 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–∞ —Å —á–∏—Å–ª–∞–º–∏
4. **–§–æ—Ä–º—É–ª—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º** - –°–£–ú–ú, –°–†–ó–ù–ê–ß, –ï–°–õ–ò, –í–ü–† (–Ω–µ SUM, AVERAGE, IF, VLOOKUP)
5. **–§–æ—Ä–º—É–ª—ã –¥–ª—è Google Sheets RU** - –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:
   - –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤: —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π `;`
   - –õ–û–ñ–¨/–ò–°–¢–ò–ù–ê –∑–∞–º–µ–Ω—è–π –Ω–∞ `0`/`1`
   - **–í–ü–† –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**: `=–í–ü–†(A2;'–õ–∏—Å—Ç'!A:H;–Ω–æ–º–µ—Ä_–∫–æ–ª–æ–Ω–∫–∏;0)` –≥–¥–µ:
     - A2 = —è—á–µ–π–∫–∞ —Å –∏—Å–∫–æ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (–∞—Ä—Ç–∏–∫—É–ª –≤ –∫–æ–ª–æ–Ω–∫–µ A, —Å—Ç—Ä–æ–∫–∞ 2)
     - '–õ–∏—Å—Ç'!A:H = –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ–∏—Å–∫–∞, –í–°–ï–ì–î–ê –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å A (–∫–æ–ª–æ–Ω–∫–∞ —Å –∫–ª—é—á–∞–º–∏)
     - –Ω–æ–º–µ—Ä_–∫–æ–ª–æ–Ω–∫–∏ = –∫–∞–∫—É—é –∫–æ–ª–æ–Ω–∫—É –≤–µ—Ä–Ω—É—Ç—å (1=A, 2=B, 8=H)
     - 0 = —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
   - –ü—Ä–∏–º–µ—Ä: `=–í–ü–†(A2;'–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞'!A:H;8;0)` - –∏—â–µ–º –∞—Ä—Ç–∏–∫—É–ª –∏–∑ A2 –≤ –ª–∏—Å—Ç–µ '–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞', –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 8-—é –∫–æ–ª–æ–Ω–∫—É
6. **–ë—É–¥—å —á–µ—Å—Ç–Ω—ã–º** - –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ, —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
7. **‚ö†Ô∏è –ü–û–î–¢–Ø–ì–ò–í–ê–ù–ò–ï –ò–ó –î–†–£–ì–û–ì–û –õ–ò–°–¢–ê**: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–∏—Å—Ç–∞ X":
   - –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –ü–£–°–¢–´–ï –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ (–≥–¥–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö) - –∏—Ö –Ω—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å!
   - –ò—Å–ø–æ–ª—å–∑—É–π **fill_columns** (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ!) —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –í–°–ï –ø—É—Å—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏
   - –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∑–Ω–∞—á–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º—É–ª—ã –í–ü–†!

   ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –î–õ–Ø –í–ü–†**:
   - –¢—ã –ù–ï –í–ò–î–ò–®–¨ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–ø—Ä–∞–≤–æ—á–Ω–æ–≥–æ –ª–∏—Å—Ç–∞!
   - –ù–æ–º–µ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫ –≤ –í–ü–† (2, 3, 4...) - —ç—Ç–æ –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–Ø!
   - **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** –¥–æ–±–∞–≤—å –≤ warnings –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–æ–º–µ—Ä–æ–≤ –∫–æ–ª–æ–Ω–æ–∫!

   **–ü–†–ò–ú–ï–†**: –¢–∞–±–ª–∏—Ü–∞ —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ [–ó–∞–∫–∞–∑, –ö–æ–¥ —Ç–æ–≤–∞—Ä–∞, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ù–∞–∑–≤–∞–Ω–∏–µ, –¶–µ–Ω–∞, –°—É–º–º–∞]
   –ï—Å–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ, –¶–µ–Ω–∞, –°—É–º–º–∞ –ø—É—Å—Ç—ã–µ ‚Üí –∑–∞–ø–æ–ª–Ω–∏ –í–°–ï –¢–†–ò:
   ```json
   {
     "action": {
       "type": "fill_columns",
       "start_row": 2,
       "columns": [
         {"target": "D", "name": "–ù–∞–∑–≤–∞–Ω–∏–µ", "values": ["=–í–ü–†(B2;'–õ–∏—Å—Ç9'!A:E;2;0)", "=–í–ü–†(B3;'–õ–∏—Å—Ç9'!A:E;2;0)", ...]},
         {"target": "E", "name": "–¶–µ–Ω–∞", "values": ["=–í–ü–†(B2;'–õ–∏—Å—Ç9'!A:E;3;0)", "=–í–ü–†(B3;'–õ–∏—Å—Ç9'!A:E;3;0)", ...]},
         {"target": "F", "name": "–°—É–º–º–∞", "values": ["=C2*E2", "=C3*E3", ...]}
       ]
     },
     "warnings": ["‚ö†Ô∏è –Ø –Ω–µ –≤–∏–∂—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ª–∏—Å—Ç–∞ '–õ–∏—Å—Ç9'. –ù–æ–º–µ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫ (2, 3) –≤ –í–ü–† - –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è! –û—Ç–∫—Ä–æ–π—Ç–µ –õ–∏—Å—Ç9 –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ: –≤ –∫–∞–∫–æ–π –∫–æ–ª–æ–Ω–∫–µ –ù–∞–∑–≤–∞–Ω–∏–µ? –í –∫–∞–∫–æ–π –¶–µ–Ω–∞? –ò—Å–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä–∞ –≤ —Ñ–æ—Ä–º—É–ª–∞—Ö."]
   }
   ```

## –ü–†–ò–ú–ï–† –•–û–†–û–®–ï–ì–û –û–¢–í–ï–¢–ê

–ó–∞–ø—Ä–æ—Å: "–°–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–π –∑–∞–∫–∞–∑—ã –Ω–∞ —è–Ω–≤–∞—Ä—å"

```json
{
  "thinking": "–í–∏–∂—É –¥–∞–Ω–Ω—ã–µ –∑–∞ 3 –º–µ—Å—è—Ü–∞: –û–∫—Ç—è–±—Ä—å, –ù–æ—è–±—Ä—å, –î–µ–∫–∞–±—Ä—å. –î–µ–∫–∞–±—Ä—å - –ø–∏–∫ –ø—Ä–æ–¥–∞–∂ (–ø—Ä–µ–¥–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π). –Ø–Ω–≤–∞—Ä—å –í–°–ï–ì–î–ê —Ö—É–∂–µ –¥–µ–∫–∞–±—Ä—è –∏–∑-–∑–∞ —Å–ø–∞–¥–∞ –ø–æ—Å–ª–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤. –ò—Å–ø–æ–ª—å–∑—É—é –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ —Å –ø–æ–Ω–∏–∂–∞—é—â–∏–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º –¥–ª—è —è–Ω–≤–∞—Ä—è.",

  "methodology": {
    "name": "weighted_average_seasonal",
    "reason": "–Ø–Ω–≤–∞—Ä—å –ø–æ—Å–ª–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∞–¥ 15-25% –æ—Ç –¥–µ–∫–∞–±—Ä—è. –≠–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è —Ç—Ä–µ–Ω–¥–∞ –∑–¥–µ—Å—å –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç - –æ–Ω–∞ –¥–∞—Å—Ç –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –≤—ã—Å–æ–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑. –ò—Å–ø–æ–ª—å–∑—É—é –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ √ó 0.85 (—Å–µ–∑–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç).",
    "formula": "–ü—Ä–æ–≥–Ω–æ–∑ = ((–û–∫—Ç√ó1 + –ù–æ—è√ó2 + –î–µ–∫√ó3) / 6) √ó 0.85",
    "copyable_formula": "=((B2*1+C2*2+D2*3)/6)*0,85"
  },

  "examples": [
    {
      "item": "–°–•_–∞–Ω–∏–º–µ–∑—Ö—Å_54",
      "input": "–û–∫—Ç=2245, –ù–æ—è=3282, –î–µ–∫=3913",
      "calculation": "–®–∞–≥ 1: –í–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ = 2245√ó1 + 3282√ó2 + 3913√ó3 = 2245 + 6564 + 11739 = 20548. –®–∞–≥ 2: –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ = 20548 / 6 = 3425. –®–∞–≥ 3: –° —Å–µ–∑–æ–Ω–Ω—ã–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º = 3425 √ó 0.85 = 2911",
      "result": "2911"
    },
    {
      "item": "–°–•_–∞–Ω–¥–µ–≥—Ä–∞—É–Ω–¥_100—à—Ç",
      "input": "–û–∫—Ç=1200, –ù–æ—è=1650, –î–µ–∫=2100",
      "calculation": "–®–∞–≥ 1: 1200√ó1 + 1650√ó2 + 2100√ó3 = 1200 + 3300 + 6300 = 10800. –®–∞–≥ 2: 10800 / 6 = 1800. –®–∞–≥ 3: 1800 √ó 0.85 = 1530",
      "result": "1530"
    },
    {
      "item": "–°–•_—Ä–æ–º–∞–Ω—Ç–∏–∫–∞_54",
      "input": "–û–∫—Ç=950, –ù–æ—è=1100, –î–µ–∫=1050",
      "calculation": "–®–∞–≥ 1: 950√ó1 + 1100√ó2 + 1050√ó3 = 950 + 2200 + 3150 = 6300. –®–∞–≥ 2: 6300 / 6 = 1050. –®–∞–≥ 3: 1050 √ó 0.85 = 893",
      "result": "893"
    }
  ],

  "result": {
    "summary": "–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ —Ñ–æ—Ä–º—É–ª–µ ((–û–∫—Ç√ó1+–ù–æ—è√ó2+–î–µ–∫√ó3)/6)√ó0.85. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 0.85 —É—á–∏—Ç—ã–≤–∞–µ—Ç —è–Ω–≤–∞—Ä—Å–∫–∏–π —Å–ø–∞–¥. –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑: ~1500, –¥–∏–∞–ø–∞–∑–æ–Ω: 100-2911.",
    "details": "–Ø–Ω–≤–∞—Ä—å —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ —Å–ª–∞–±–µ–µ –¥–µ–∫–∞–±—Ä—è –Ω–∞ 15-25%. –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –¥–∞—ë—Ç –±–æ–ª—å—à–∏–π –≤–µ—Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –º–µ—Å—è—Ü–∞–º. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 0.85 –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –Ω–∞ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å."
  },

  "action": {
    "type": "write_column",
    "key_column": "–ê—Ä—Ç–∏–∫—É–ª",
    "new_column_name": "–ü—Ä–æ–≥–Ω–æ–∑ –Ø–Ω–≤–∞—Ä—å",
    "values": [
      ["–°–•_–∞–Ω–∏–º–µ–∑—Ö—Å_54", 2911],
      ["–°–•_–∞–Ω–¥–µ–≥—Ä–∞—É–Ω–¥_100—à—Ç", 1530],
      ["–°–•_—Ä–æ–º–∞–Ω—Ç–∏–∫–∞_54", 893],
      ... –í–°–ï 134 —Å—Ç—Ä–æ–∫–∏ ...
    ]
  },

  "confidence": 0.75,
  "warnings": ["–ü—Ä–æ–≥–Ω–æ–∑ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–∏–ø–∏—á–Ω—ã–π —è–Ω–≤–∞—Ä—Å–∫–∏–π —Å–ø–∞–¥. –ï—Å–ª–∏ –≤–∞—à –±–∏–∑–Ω–µ—Å –Ω–µ –ø–æ–¥–≤–µ—Ä–∂–µ–Ω —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω–∏–∂–µ–Ω."]
}
```

**–í–ê–ñ–ù–û: –≤ values –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–°–ï —Å—Ç—Ä–æ–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä—ã!**"""

    def __init__(self, api_key: str):
        self.client = AsyncOpenAI(api_key=api_key)

    def format_data_as_table(self, df: pd.DataFrame, column_names: List[str], max_rows: int = 1000) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —á–∏—Ç–∞–µ–º—É—é —Ç–∞–±–ª–∏—Ü—É"""

        lines = []

        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö
        total_rows = len(df)
        show_rows = min(total_rows, max_rows)

        if total_rows > max_rows:
            lines.append(f"–¢–ê–ë–õ–ò–¶–ê: {total_rows} —Å—Ç—Ä–æ–∫ √ó {len(column_names)} –∫–æ–ª–æ–Ω–æ–∫ (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ {show_rows})")
        else:
            lines.append(f"–¢–ê–ë–õ–ò–¶–ê: {total_rows} —Å—Ç—Ä–æ–∫ √ó {len(column_names)} –∫–æ–ª–æ–Ω–æ–∫")

        lines.append("")

        # v11.5: –Ø–≤–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –∏ –±—É–∫–≤ Excel
        lines.append("–ö–û–õ–û–ù–ö–ò –ò –ë–£–ö–í–´ EXCEL:")
        for i, col in enumerate(column_names):
            letter = chr(65 + i)  # A, B, C, ...
            lines.append(f"  {letter} = {col}")
        lines.append("")

        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å –±—É–∫–≤–∞–º–∏ –∫–æ–ª–æ–Ω–æ–∫ (Row - –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏, –ù–ï –∫–æ–ª–æ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö!)
        headers_with_letters = [f"{col} ({chr(65 + i)})" for i, col in enumerate(column_names)]
        lines.append("| Row | " + " | ".join(headers_with_letters) + " |")
        lines.append("|-----|" + "|".join(["---"] * len(column_names)) + "|")

        # –î–∞–Ω–Ω—ã–µ
        for idx, (_, row) in enumerate(df.head(show_rows).iterrows()):
            row_num = idx + 2  # +2 because row 1 is header in sheets
            values = []
            for col in column_names:
                if col in df.columns:
                    val = row[col]
                    if pd.isna(val):
                        values.append("")
                    elif isinstance(val, float):
                        values.append(f"{val:.0f}" if val == int(val) else f"{val:.2f}")
                    else:
                        # v11.5: Escape pipe character to prevent table parsing issues
                        val_str = str(val)[:30].replace('|', '/')
                        values.append(val_str)
                else:
                    values.append("")
            lines.append(f"| {row_num} | " + " | ".join(values) + " |")

        if total_rows > max_rows:
            lines.append(f"| ... | –µ—â—ë {total_rows - max_rows} —Å—Ç—Ä–æ–∫ ... |")

        return "\n".join(lines)

    async def analyze(
        self,
        query: str,
        df: pd.DataFrame,
        column_names: List[str],
        context: Optional[str] = None,
        history: Optional[List[Dict]] = None,
        reference_df: Optional[pd.DataFrame] = None,
        reference_sheet_name: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∞–Ω–∞–ª–∏–∑–∞
        """
        start_time = time.time()

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        data_text = self.format_data_as_table(df, column_names)

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π –ª–∏—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å (–¥–ª—è VLOOKUP)
        reference_text = ""
        if reference_df is not None and reference_sheet_name:
            ref_cols = list(reference_df.columns)
            reference_text = f"""

–°–ü–†–ê–í–û–ß–ù–´–ô –õ–ò–°–¢ "{reference_sheet_name}" (–¥–ª—è –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö):
{self.format_data_as_table(reference_df, ref_cols, max_rows=100)}
"""

        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context_text = f"\n–†–û–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {context}\n" if context else ""

        # –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ - –≤–∞–∂–Ω–æ –¥–ª—è follow-up –≤–æ–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "–∫–∞–∫ —Ç—ã —ç—Ç–æ —Ä–∞—Å—Å—á–∏—Ç–∞–ª?"
        history_text = ""
        if history:
            history_text = "\n–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê (–æ—Ç–≤–µ—á–∞–π —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞!):\n"
            for h in history[-3:]:
                q = h.get('query', '')
                # v11.5: –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
                r = str(h.get('response', h.get('summary', '')))[:500]
                history_text += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {q}\n–¢–≤–æ–π –æ—Ç–≤–µ—Ç: {r}\n---\n"
            history_text += "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç '–∫–∞–∫ —Ç—ã —ç—Ç–æ —Ä–∞—Å—Å—á–∏—Ç–∞–ª?' –∏–ª–∏ '–ø–æ—á–µ–º—É?' - –æ—Ç–≤–µ—á–∞–π –ø—Ä–æ –ü–†–ï–î–´–î–£–©–ò–ô –≤–æ–ø—Ä–æ—Å!\n"

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        user_prompt = f"""{context_text}{history_text}
{data_text}
{reference_text}

–í–û–ü–†–û–°: {query}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–≤–µ—Ç—å –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ. –ü–æ–∫–∞–∂–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è, –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—é –∏ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á—ë—Ç–æ–≤."""

        try:
            logger.info(f"[CleanAnalyst] Query: {query[:50]}...")
            logger.info(f"[CleanAnalyst] Data: {len(df)} rows, {len(column_names)} cols")

            response = await self.client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": self.SYSTEM_PROMPT},
                    {"role": "user", "content": user_prompt}
                ],
                temperature=0.1,  # –ù–∏–∑–∫–∞—è –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                max_tokens=16000,
                response_format={"type": "json_object"}
            )

            result_text = response.choices[0].message.content
            finish_reason = response.choices[0].finish_reason
            logger.info(f"[CleanAnalyst] Response length: {len(result_text)}, finish_reason: {finish_reason}")

            # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –æ–±—Ä–µ–∑–∞–Ω - –ø—Ä–æ–±—É–µ–º –∑–∞–≤–µ—Ä—à–∏—Ç—å JSON
            if finish_reason == 'length':
                logger.warning("[CleanAnalyst] ‚ö†Ô∏è Response truncated due to max_tokens limit!")
                # –ü—Ä–æ–±—É–µ–º –∑–∞–∫—Ä—ã—Ç—å –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π JSON
                # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—Ç–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë
                open_braces = result_text.count('{') - result_text.count('}')
                open_brackets = result_text.count('[') - result_text.count(']')
                closing = ']' * open_brackets + '}' * open_braces
                if closing:
                    result_text = result_text.rstrip().rstrip(',') + closing
                    logger.info(f"[CleanAnalyst] Appended closing brackets: {closing}")

            # –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON —Å fallback
            try:
                result = json.loads(result_text)
            except json.JSONDecodeError as parse_err:
                logger.warning(f"[CleanAnalyst] Initial JSON parse failed at pos {parse_err.pos}, trying to fix...")
                import re as re_mod

                # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ —Ç–µ–∫—Å—Ç–∞
                json_match = re_mod.search(r'\{[\s\S]*\}', result_text)
                if json_match:
                    fixed_json = json_match.group()

                    # Fix 1: –£–±–∏—Ä–∞–µ–º trailing commas –ø–µ—Ä–µ–¥ } –∏–ª–∏ ]
                    fixed_json = re_mod.sub(r',\s*([}\]])', r'\1', fixed_json)

                    # Fix 2: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–µ –º–µ–∂–¥—É —á–∏—Å–ª–∞–º–∏ –≤ –º–∞—Å—Å–∏–≤–∞—Ö
                    # [123 456] -> [123, 456]
                    fixed_json = re_mod.sub(r'(\d)\s+(\d)', r'\1, \2', fixed_json)

                    # Fix 3: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–µ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏ –≤ –º–∞—Å—Å–∏–≤–∞—Ö
                    # ["a" "b"] -> ["a", "b"]
                    fixed_json = re_mod.sub(r'"\s+"', '", "', fixed_json)

                    # Fix 4: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–µ –ø–æ—Å–ª–µ ] –∏–ª–∏ } –ø–µ—Ä–µ–¥ "
                    # }  "key" -> }, "key"
                    fixed_json = re_mod.sub(r'([}\]])\s*"', r'\1, "', fixed_json)

                    try:
                        result = json.loads(fixed_json)
                        logger.info("[CleanAnalyst] JSON fixed successfully")
                    except json.JSONDecodeError as fix_err:
                        # –õ–æ–≥–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –≤–æ–∫—Ä—É–≥ –æ—à–∏–±–∫–∏
                        err_start = max(0, fix_err.pos - 150)
                        err_end = min(len(fixed_json), fix_err.pos + 150)
                        logger.error(f"[CleanAnalyst] JSON error at pos {fix_err.pos}: ...{fixed_json[err_start:err_end]}...")
                        raise fix_err
                else:
                    raise parse_err

            elapsed = time.time() - start_time

            logger.info(f"[CleanAnalyst] Thinking: {result.get('thinking', '')[:100]}...")
            logger.info(f"[CleanAnalyst] Method: {result.get('methodology', {}).get('name', 'N/A')}")
            logger.info(f"[CleanAnalyst] Action: {result.get('action', {}).get('type', 'N/A')}")
            logger.info(f"[CleanAnalyst] Time: {elapsed:.2f}s")

            return {
                "success": True,
                "gpt_response": result,
                "processing_time": f"{elapsed:.2f}s"
            }

        except json.JSONDecodeError as e:
            logger.error(f"[CleanAnalyst] JSON parse error: {e}")
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–∫—Ä—É–≥ –æ—à–∏–±–∫–∏
            err_pos = e.pos if hasattr(e, 'pos') else 0
            err_start = max(0, err_pos - 200)
            err_end = min(len(result_text), err_pos + 200)
            logger.error(f"[CleanAnalyst] Response length: {len(result_text)}")
            logger.error(f"[CleanAnalyst] Error context around pos {err_pos}: ...{result_text[err_start:err_end]}...")
            return {"success": False, "error": f"JSON parse error: {e}"}
        except Exception as e:
            logger.error(f"[CleanAnalyst] Error: {e}", exc_info=True)
            return {"success": False, "error": str(e)}

    def transform_to_frontend_format(self, gpt_response: Dict, processing_time: str) -> Dict[str, Any]:
        """
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –æ—Ç–≤–µ—Ç GPT –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
        """

        action = gpt_response.get("action", {})
        action_type = action.get("type", "answer")
        methodology = gpt_response.get("methodology", {})
        examples = gpt_response.get("examples", [])
        result = gpt_response.get("result", {})

        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
        explanation_parts = []

        # –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è
        if methodology:
            explanation_parts.append(f"–ú–ï–¢–û–î: {methodology.get('name', 'N/A')}")
            if methodology.get('reason'):
                explanation_parts.append(methodology['reason'])
            if methodology.get('formula'):
                explanation_parts.append(f"–§–æ—Ä–º—É–ª–∞: {methodology['formula']}")
            explanation_parts.append("")

        # –ü—Ä–∏–º–µ—Ä—ã
        if examples:
            explanation_parts.append("–ü–†–ò–ú–ï–†–´ –†–ê–°–ß–Å–¢–û–í:")
            for ex in examples[:5]:
                explanation_parts.append(f"‚Ä¢ {ex.get('item', 'N/A')}")
                explanation_parts.append(f"  –î–∞–Ω–Ω—ã–µ: {ex.get('input', '')}")
                explanation_parts.append(f"  –†–∞—Å—á—ë—Ç: {ex.get('calculation', '')}")
                explanation_parts.append(f"  –†–µ–∑—É–ª—å—Ç–∞—Ç: {ex.get('result', '')}")
                explanation_parts.append("")

        explanation = "\n".join(explanation_parts)

        # Translate copyable_formula if present
        if methodology.get('copyable_formula'):
            methodology['copyable_formula'] = self._translate_formula(methodology['copyable_formula'])

        # –ë–∞–∑–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        response = {
            "success": True,
            "formula": None,
            "explanation": explanation,
            "target_cell": None,
            "confidence": gpt_response.get("confidence", 0.9),
            "response_type": "analysis",
            "summary": result.get("summary", ""),
            "methodology": methodology,
            "thinking": gpt_response.get("thinking", ""),
            "examples": examples,  # v11.0: Pass examples for frontend display
            "insights": [],
            "key_findings": [result.get("details", "")] if result.get("details") else [],
            "warnings": gpt_response.get("warnings", []),
            "processing_time": processing_time,
            "processor_version": "CleanAnalyst v1.0",
            "python_executed": False  # GPT —Å–∞–º –≤—Å—ë —Å—á–∏—Ç–∞–µ—Ç
        }

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º action –≤ —Ñ–æ—Ä–º–∞—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
        if action_type == "write_column":
            response["action_type"] = "write_data"
            response["merge_by_key"] = action.get("key_column")
            response["write_headers"] = [action.get("key_column"), action.get("new_column_name")]
            response["write_data"] = action.get("values", [])

        elif action_type == "highlight":
            response["action_type"] = "highlight"
            response["highlight_rows"] = action.get("rows", [])
            response["highlight_color"] = action.get("color", "#FFCCCB")
            response["highlight_message"] = action.get("reason", "")

        elif action_type == "conditional_format":
            response["action_type"] = "conditional_format"
            response["conditional_rules"] = action.get("rules", [])

        elif action_type == "sort":
            response["action_type"] = "sort"
            response["sort_column"] = action.get("column")
            response["sort_column_index"] = action.get("column_index")
            response["sort_order"] = action.get("order", "desc")

        elif action_type == "chart":
            response["action_type"] = "chart"
            response["chart_spec"] = {
                "chart_type": action.get("chart_type", "COLUMN"),
                "title": action.get("title", ""),
                "x_column_index": action.get("x_column_index", 0),
                "y_column_indices": action.get("y_column_indices", [1]),
                "row_count": action.get("row_count", 100)
            }

        elif action_type == "formula":
            response["response_type"] = "formula"
            response["formula"] = self._translate_formula(action.get("formula", ""))
            response["target_cell"] = action.get("target_cell")
            response["explanation"] = action.get("explanation", "")

        elif action_type == "fill_column":
            # fill_column - write values directly to a specific column without key matching
            response["action_type"] = "fill_column"
            response["target_column"] = action.get("target_column")  # e.g., "E"
            response["column_name"] = action.get("column_name")  # e.g., "–ü—Ä–æ–≥–Ω–æ–∑"
            response["start_row"] = action.get("start_row", 2)  # Row to start writing (default: 2, after header)
            response["fill_values"] = action.get("values", [])  # List of values to write

            # –ï—Å–ª–∏ values –ø—É—Å—Ç–æ–π, –Ω–æ –µ—Å—Ç—å copyable_formula - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
            if not response["fill_values"] and methodology.get("copyable_formula"):
                base_formula = methodology.get("copyable_formula")
                start_row = response["start_row"]
                # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–µ–¥–∞–Ω–æ –≤ transform)
                row_count = gpt_response.get("_row_count", 100)
                logger.info(f"[CleanAnalyst] Generating {row_count} formulas from: {base_formula}")

                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É–ª—É –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ (–∑–∞–º–µ–Ω—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏)
                formulas = []
                for i in range(row_count):
                    row_num = start_row + i
                    # –ó–∞–º–µ–Ω—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫ –≤ —Ñ–æ—Ä–º—É–ª–µ (B2->B3, C2->C3, –∏ —Ç.–¥.)
                    row_formula = re.sub(r'([A-Z])2(?![0-9])', lambda m: f"{m.group(1)}{row_num}", base_formula)
                    formulas.append(row_formula)

                response["fill_values"] = formulas
                logger.info(f"[CleanAnalyst] Generated {len(formulas)} formulas, first: {formulas[0] if formulas else 'none'}")

        elif action_type == "fill_columns":
            # fill_columns - write values to multiple columns at once
            response["action_type"] = "fill_columns"
            response["start_row"] = action.get("start_row", 2)
            response["columns"] = action.get("columns", [])  # List of {target, name, values}

        elif action_type == "replace_data":
            # replace_data - full data replacement (for CSV split, restructure)
            response["action_type"] = "replace_data"
            response["structured_data"] = {
                "headers": action.get("headers", []),
                "rows": action.get("rows", [])
            }

        else:  # answer
            response["action_type"] = None
            response["summary"] = action.get("text", result.get("summary", ""))

        return response

    def _translate_formula(self, formula: str) -> str:
        """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ä—É—Å—Å–∫–∏–µ (–¥–ª—è Google Sheets RU)"""

        translations = {
            'SUM': '–°–£–ú–ú', 'AVERAGE': '–°–†–ó–ù–ê–ß', 'COUNT': '–°–ß–Å–¢', 'COUNTA': '–°–ß–Å–¢–ó',
            'IF': '–ï–°–õ–ò', 'SUMIF': '–°–£–ú–ú–ï–°–õ–ò', 'COUNTIF': '–°–ß–Å–¢–ï–°–õ–ò',
            'VLOOKUP': '–í–ü–†', 'HLOOKUP': '–ì–ü–†', 'INDEX': '–ò–ù–î–ï–ö–°', 'MATCH': '–ü–û–ò–°–ö–ü–û–ó',
            'MAX': '–ú–ê–ö–°', 'MIN': '–ú–ò–ù', 'AND': '–ò', 'OR': '–ò–õ–ò',
            'LEFT': '–õ–ï–í–°–ò–ú–í', 'RIGHT': '–ü–†–ê–í–°–ò–ú–í', 'MID': '–ü–°–¢–†', 'LEN': '–î–õ–°–¢–†',
            'ROUND': '–û–ö–†–£–ì–õ', 'IFERROR': '–ï–°–õ–ò–û–®–ò–ë–ö–ê', 'ISBLANK': '–ï–ü–£–°–¢–û',
            'TODAY': '–°–ï–ì–û–î–ù–Ø', 'NOW': '–¢–î–ê–¢–ê', 'YEAR': '–ì–û–î', 'MONTH': '–ú–ï–°–Ø–¶', 'DAY': '–î–ï–ù–¨',
            'FILTER': '–§–ò–õ–¨–¢–†', 'SORT': '–°–û–†–¢', 'UNIQUE': '–£–ù–ò–ö',
            'SUMIFS': '–°–£–ú–ú–ï–°–õ–ò–ú–ù', 'COUNTIFS': '–°–ß–Å–¢–ï–°–õ–ò–ú–ù', 'AVERAGEIF': '–°–†–ó–ù–ê–ß–ï–°–õ–ò',
            'SPLIT': '–†–ê–ó–î–ï–õ–ò–¢–¨', 'CONCATENATE': '–°–¶–ï–ü–ò–¢–¨', 'CONCAT': '–°–¶–ï–ü',
            'TRIM': '–°–ñ–ü–†–û–ë–ï–õ–´', 'UPPER': '–ü–†–û–ü–ò–°–ù', 'LOWER': '–°–¢–†–û–ß–ù', 'PROPER': '–ü–†–û–ü–ù–ê–ß',
            'TEXT': '–¢–ï–ö–°–¢', 'VALUE': '–ó–ù–ê–ß–ï–ù', 'FIND': '–ù–ê–ô–¢–ò', 'SEARCH': '–ü–û–ò–°–ö',
            'REPLACE': '–ó–ê–ú–ï–ù–ò–¢–¨', 'SUBSTITUTE': '–ü–û–î–°–¢–ê–í–ò–¢–¨', 'TRANSPOSE': '–¢–†–ê–ù–°–ü',
            'ARRAYFORMULA': '–ú–ê–°–°–ò–í', 'QUERY': 'QUERY', 'IMPORTRANGE': 'IMPORTRANGE'
        }

        result = formula
        for eng, rus in translations.items():
            # Replace only function names (followed by opening parenthesis)
            result = re.sub(rf'\b{eng}\s*\(', f'{rus}(', result, flags=re.IGNORECASE)

        # Replace commas with semicolons (Russian locale)
        # But not inside quoted strings
        parts = []
        in_quotes = False
        current = ""
        for char in result:
            if char == '"':
                in_quotes = not in_quotes
            if char == ',' and not in_quotes:
                current += ';'
            else:
                current += char
        result = current

        return result
